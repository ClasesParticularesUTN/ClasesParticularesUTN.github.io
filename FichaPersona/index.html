<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ficha del Alumno</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Loader Spinner */
    #loaderSpinner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255,255,255,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      transition: opacity 0.3s;
    }
    .lds-dual-ring {
      display: inline-block;
      width: 80px;
      height: 80px;
    }
    .lds-dual-ring:after {
      content: " ";
      display: block;
      width: 64px;
      height: 64px;
      margin: 8px;
      border-radius: 50%;
      border: 6px solid #0077cc;
      border-color: #0077cc transparent #0077cc transparent;
      animation: lds-dual-ring 1.2s linear infinite;
    }
    @keyframes lds-dual-ring {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }
    main {
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);

      width: 100%;
      padding: 30px 40px;
    }
    h1 {
      font-weight: 700;
      font-size: 2.2rem;
      margin-bottom: 20px;
      color: #222;
      border-bottom: 3px solid #0077cc;
      padding-bottom: 8px;
    }
    #error {
      color: #d9534f;
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
      display: none;
    }
    .info-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 35px;
    }
    .card {
      flex: 1 1 45%;
      background: #f9fafb;
      border-radius: 10px;
      padding: 18px 22px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      display: flex;
      align-items: center;
      gap: 15px;
      min-width: 250px;
    }
    .card .icon {
      font-size: 1.8rem;
      color: #0077cc;
      width: 30px;
      text-align: center;
    }
    .card .label {
      font-weight: 600;
      color: #555;
      flex: 0 0 130px;
      user-select: none;
    }
    .card .value {
      font-weight: 500;
      color: #111;
      flex: 1;
      word-break: break-word;
    }
    h2 {
      font-weight: 700;
      font-size: 1.8rem;
      margin-bottom: 15px;
      color: #222;
      border-bottom: 2px solid #0077cc;
      padding-bottom: 6px;
    }
    table.reservas {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 10px;
      font-size: 0.95rem;
      color: #333;
    }
    table.reservas thead tr {
      background-color: #0077cc;
      color: white;
      border-radius: 8px;
      user-select: none;
    }
    table.reservas th, table.reservas td {
      padding: 12px 15px;
      text-align: left;
    }
    table.reservas tbody tr {
      background: white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }
    table.reservas tbody tr:hover {
      background-color: #e6f0fb;
    }
    table.reservas tbody tr td {
      border: none;
    }
    .verMas{
        display: none;
        
    }
    /* Responsive */
    @media (max-width: 520px) {
      .info-cards {
        flex-direction: column;
      }
      .card {
        flex: 1 1 100%;
      }
      table.reservas th, table.reservas td {
        padding: 10px 8px;
      }
      .ocultar{
        display: none;
      }
      .verMas{
        display: block;
        color: #0077cc;
        text-decoration: underline;
        cursor: pointer;
      }
      .value{
        font-size: 80%;
      }
      .listadoreservas{
        font-size:80%;
        text-align:center;
      }
    }
    
  </style>
</head>
<body>
  <div id="loaderSpinner"><div class="lds-dual-ring"></div></div>
  <main style="display:none;">
    <h1>Ficha del Alumno</h1>
    <div id="error"></div>

    <section class="info-cards">
      <div class="card"><div class="icon">üë§</div><div class="label">Nombre</div><div class="value ocultar" id="nombre"></div><div class="verMas" data-target="nombre">Ver m√°s</div></div>
      <div class="card"><div class="icon">üë•</div><div class="label">Apellido</div><div class="value ocultar" id="apellido"></div><div class="verMas" data-target="apellido">Ver m√°s</div></div>
      <div class="card"><div class="icon">‚úâÔ∏è</div><div class="label">Correo electr√≥nico</div><div class="value ocultar" id="correoElectronico"></div><div class="verMas" data-target="correoElectronico">Ver m√°s</div></div>
      <div class="card"><div class="icon">üìû</div><div class="label">Tel√©fono</div><div class="value ocultar" id="telefono"></div><div class="verMas" data-target="telefono">Ver m√°s</div></div>
      <div class="card"><div class="icon">üìÖ</div><div class="label">A√±o Ingreso</div><div class="value ocultar" id="anioIngreso"></div><div class="verMas" data-target="anioIngreso">Ver m√°s</div></div>
      <div class="card"><div class="icon">üìö</div><div class="label">Materia</div><div class="value ocultar" id="materia"></div><div class="verMas" data-target="materia">Ver m√°s</div></div>
      <div class="card"><div class="icon">üìù</div><div class="label">Estado en la materia</div><div class="value ocultar" id="estadoEnLaMateria"></div><div class="verMas" data-target="estadoEnLaMateria">Ver m√°s</div></div>
      <div class="card"><div class="icon">üí¨</div><div class="label">Comentario</div><div class="value ocultar" id="comentario"></div><div class="verMas" data-target="comentario">Ver m√°s</div></div>
      <div class="card"><div class="icon">‚è∞</div><div class="label">Horas a favor</div><div class="value" id="horasAFavor"></div></div>
      <div class="card"><div class="icon">üí≥</div><div class="label">Fecha de pago</div><div class="value" id="fechaDePago"></div></div>
      <div class="card"><div class="icon">üí∞</div><div class="label">Dinero que debe</div><div class="value" id="dineroQueDebe"></div></div>
      <div class="card"><div class="icon">üéÅ</div><div class="label">Pack</div><div class="value" id="pack"></div></div>
    </section>

    <!-- Modal para mostrar info en m√≥vil -->
    <div id="modalInfo" style="display:none; position:fixed; z-index:3000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); align-items:center; justify-content:center;">
      <div style="background:white; border-radius:12px; max-width:90vw; padding:48px 20px 28px 20px; box-shadow:0 4px 24px rgba(0,0,0,0.18); text-align:center; position:relative;">
        <button id="cerrarModalInfo" style="position:absolute; top:8px; right:12px; background:none; border:none; font-size:1.7rem; cursor:pointer; color:#0077cc;">&times;</button>
        <div id="modalInfoLabel" style="font-weight:600; color:#0077cc; font-size:1.1rem; margin-bottom:10px;"></div>
        <div id="modalInfoValue" style="font-size:1.1rem; color:#222;"></div>
      </div>
    </div>

    <h2>Horarios Reservados</h2>
    <table class="reservas" aria-label="Tabla de horarios reservados">
      <thead>
        <tr>
          <th>Fecha Realizado</th>
          <th>Fecha Reservado</th>
          <th>Estado</th>
          <th style="text-align: center;">Cant Horas</th>
        </tr>
      </thead>
      <tbody id="reservasBody">
        <!-- Se llenar√° con JavaScript -->
      </tbody>
    </table>
    
  </main>
<div id="scrollToBottomBtn" 
     style="position: fixed; bottom: 24px; right: 24px; font-size: 3rem; z-index: 1000; border-radius: 50%; padding: 10px 14px; cursor: pointer; transform: rotate(270deg); user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; touch-action: manipulation;" 
     tabindex="0" aria-label="Ir al final" role="button"
     oncontextmenu="return false;"
     draggable="false"
     >üîö</div>
<script src="../Horarios/JS/URLS.js"></script>
<script>
    // Bot√≥n para ir al final de la p√°gina
    const scrollBtn = document.getElementById("scrollToBottomBtn");
    scrollBtn.onclick = function(e) {
        e.preventDefault();
        window.scrollTo({ top: document.body.scrollHeight });
    };
    // Prevenir selecci√≥n y acciones contextuales en m√≥viles
    scrollBtn.addEventListener('mousedown', e => e.preventDefault());
    scrollBtn.addEventListener('selectstart', e => e.preventDefault());
    scrollBtn.addEventListener('dragstart', e => e.preventDefault());
    scrollBtn.addEventListener('contextmenu', e => e.preventDefault());

    // Modal para mostrar info de la card en m√≥vil
    const modal = document.getElementById('modalInfo');
    const modalLabel = document.getElementById('modalInfoLabel');
    const modalValue = document.getElementById('modalInfoValue');
    const cerrarModal = document.getElementById('cerrarModalInfo');
    cerrarModal.onclick = () => { modal.style.display = 'none'; };
    // Cerrar modal al tocar fuera del contenido
    modal.addEventListener('click', function(e) {
      if (e.target === modal) modal.style.display = 'none';
    });
    // Asignar eventos a los botones "Ver m√°s"
    document.querySelectorAll('.verMas').forEach(btn => {
      btn.onclick = function() {
        const targetId = btn.getAttribute('data-target');
        const label = btn.parentElement.querySelector('.label').textContent;
        const value = document.getElementById(targetId).textContent;
        modalLabel.textContent = label;
        modalValue.textContent = value;
        modal.style.display = 'flex';
      };
    });

    // Mostrar loader y ocultar main al inicio
    const loader = document.getElementById("loaderSpinner");
    const main = document.querySelector("main");
    loader.style.display = "flex";
    main.style.display = "none";

    // Obtener par√°metros de la URL
    const params = new URLSearchParams(window.location.search);
    let nombre = params.get("nombre");
    let apellido = params.get("apellido");
    if (!nombre) {
      nombre = JSON.parse(localStorage.getItem("Nombre")) || "";
      console.log("no hubo parametros")
    }
    if (!apellido) {
      apellido = JSON.parse(localStorage.getItem("Apellido")) || "";
    }

    if(nombre == "" || apellido == ""){
        window.location = '/Horarios/IniciarSesion/IniciarSesion.html';
    }

    const url = URLUsuarios +
                            `?funcion=devolverFicha&nombre=${encodeURIComponent(nombre)}&apellido=${encodeURIComponent(apellido)}`;
    console.log(url)
    fetch(url)
        .then(res => res.json())
        .then(data => {
            const errorDiv = document.getElementById("error");
            if (data.error) {
                errorDiv.textContent = data.error;
                errorDiv.style.display = "block";
                loader.style.display = "none";
                main.style.display = "block";
                return;
            }
            errorDiv.style.display = "none";
            // Datos personales
            document.getElementById("nombre").textContent = data.nombre || "";
            document.getElementById("apellido").textContent = data.apellido || "";
            document.getElementById("correoElectronico").textContent = data.correoElectronico || "";
            document.getElementById("telefono").textContent = data.telefono || "";
            document.getElementById("anioIngreso").textContent = data.anoIngreso || "";
            document.getElementById("materia").textContent = data.materia || "";
            document.getElementById("estadoEnLaMateria").textContent = data.estadoEnLaMateriaa || "";
            document.getElementById("comentario").textContent = data.comentario || "";
            document.getElementById("horasAFavor").textContent = data.horasAFavor || "Sin horas a favor";
            document.getElementById("fechaDePago").textContent = data.fechaDePago || "No pag√≥ pack";
            document.getElementById("dineroQueDebe").textContent = data.dineroQueDebe || "0";
            document.getElementById("pack").textContent = data.pack || "No pag√≥ pack";

            if(parseInt(document.getElementById("dineroQueDebe").textContent) > 0) {
                document.getElementById("dineroQueDebe").style.color = "red";
                document.getElementById("dineroQueDebe").textContent = "$"+document.getElementById("dineroQueDebe").textContent;
                Swal.fire({
                    icon: 'warning',
                    title: '¬°Atenci√≥n!',
                    text: 'Recuerde que debe dinero.',
                    confirmButtonText: 'Entendido'
                });
            }
            // Reservas
            const tbody = document.getElementById("reservasBody");
            tbody.innerHTML = ""; // limpiar por si hab√≠a algo antes

            (data.reservas || []).forEach(r => {
                const fila = document.createElement("tr");
                fila.innerHTML = `
                    <td class="listadoReservas">${r.fechaRealizado}</td>
                    <td class="listadoReservas">${r.fechaReservado}</td>
                    <td class="listadoReservas">${r.estado}</td>
                    <td class="listadoReservas">${r.cantHoras}</td>
                `;
                tbody.appendChild(fila);
                if (r.estado && typeof r.estado === "string") {
                    const celdasTd = fila.children[fila.children.length - 2];
                    if (r.estado.toLowerCase().includes("debe")) {
                        celdasTd.style.backgroundColor = "#ffd6d6";
                        
                    } else if (r.estado.toLowerCase().includes("pago")) {
                        celdasTd.style.backgroundColor = "#2e7d32";
                        celdasTd.style.color = "#fff";
                        
                    } else if (r.estado.toLowerCase().includes("pack")) {
                        celdasTd.style.backgroundColor = "#d0f5e8";
                        
                    }
                    celdasTd.style.borderRadius = "10%";
                    
                }
            });
            // Ocultar loader y mostrar main
            loader.style.display = "none";
            main.style.display = "block";
        })
        .catch(err => {
            console.error("Error al cargar los datos:", err);
            const errorDiv = document.getElementById("error");
            errorDiv.textContent = "Ocurri√≥ un error al obtener los datos.";
            errorDiv.style.display = "block";
            loader.style.display = "none";
            main.style.display = "block";
        });


</script>
</body>
</html>
