<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Acceso - C/S</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #f3a661;
            --primary-hover: #e68a3d;
            --bg-glass: rgba(18, 18, 18, 0.85);
            --input-focus: rgba(243, 166, 97, 0.2);
            --text-muted: #aaa;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background: url('https://images.unsplash.com/photo-1555066931-4365d14bab8c?auto=format&fit=crop&w=1920&q=80') no-repeat center center fixed;
            background-size: cover;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #fff;
        }

        .container {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            width: 100%;
            max-width: 420px;
            padding: 40px;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            text-align: center;
        }

        .logo-box { margin-bottom: 25px; }
        .logo-circle { display: inline-block; border: 2px solid var(--primary); border-radius: 50%; padding: 12px; margin-bottom: 10px; }
        .logo-text { font-size: 1.5rem; font-weight: 600; border-bottom: 2px solid var(--primary); line-height: 1; }
        
        h2 { font-weight: 600; margin-bottom: 10px; font-size: 1.4rem; }
        .subtitle { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 30px; line-height: 1.5; }

        .form-group { text-align: left; margin-bottom: 18px; }
        .form-label { display: block; margin-bottom: 8px; font-size: 0.75rem; color: #ddd; text-transform: uppercase; letter-spacing: 1px; }

        .input-control {
            width: 100%; padding: 14px 16px; background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; color: #fff;
            font-size: 1rem; transition: all 0.3s ease;
        }

        .input-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px var(--input-focus); }

        /* Clase dinámica para mostrar/ocultar campos según el JS */
        .codigo { display: none; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; margin-top: 20px; }

        .btn-submit {
            width: 100%; padding: 16px; background: var(--primary); border: none;
            border-radius: 12px; color: #000; font-size: 0.95rem; font-weight: 700;
            text-transform: uppercase; cursor: pointer; transition: all 0.3s; margin-top: 10px;
        }

        .btn-submit:hover { background: var(--primary-hover); transform: translateY(-2px); }

        .back-link { display: inline-block; margin-top: 25px; color: var(--text-muted); text-decoration: none; font-size: 0.85rem; transition: 0.3s; }
        .back-link:hover { color: var(--primary); }

        /* Loader */
        .contenedorLoader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); display: none; justify-content: center; 
            align-items: center; z-index: 1000; backdrop-filter: blur(4px);
        }
        .loader {
            width: 40px; height: 40px; border: 4px solid #FFF; 
            border-bottom-color: var(--primary); border-radius: 50%; 
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="contenedorLoader"><div class="loader"></div></div>

    <div class="container">
        <div class="logo-box">
            <div class="logo-circle"><div class="logo-text">C/S</div></div>
            <h2>Recuperar Clave</h2>
            <p class="subtitle" id="instruccion">Ingresa tu correo para recibir un código de verificación.</p>
        </div>

        <form id="formularioRegistro">
            <div class="form-group">
                <label class="form-label">Correo Electrónico</label>
                <input type="email" name="correo" class="input-control" placeholder="ejemplo@utn.com" required>
            </div>

            <div class="codigo">
                <div class="form-group">
                    <label class="form-label">Nueva Contraseña</label>
                    <input type="password" name="nuevaContrasenia" class="input-control" placeholder="••••••••">
                </div>
                <div class="form-group">
                    <label class="form-label">Código de Verificación</label>
                    <input type="text" id="codigoUsuario" class="input-control" placeholder="Escribe el código aquí">
                </div>
            </div>

            <button type="submit" class="btn-submit" id="botonEnviar">Enviar Codigo</button>
        </form>

        <a href="Login.html" class="back-link">← Volver al inicio de sesión</a>
    </div>

    <script>
        const URLUsuarios = "TU_URL_DE_APPS_SCRIPT"; 
        let clave = generarCadenaAleatoria();

        document.getElementById('formularioRegistro').addEventListener('submit', function (event) {
            event.preventDefault();

            if (document.querySelector("#botonEnviar").innerHTML == "Enviar Codigo") {
                let formData = new FormData(this);
                let datosAEnviar = [];
                formData.forEach((valor) => { datosAEnviar.push(valor); });
                
                datosAEnviar[0] = datosAEnviar[0].toLowerCase();
                let urlFinal = URLUsuarios + "?correo=" + encodeURIComponent(datosAEnviar[0]) + "&funcion=recuperarContrasenia" + "&codigo=" + clave;
                enviarCodigo(urlFinal);
            } else {
                let texto = document.querySelector("#codigoUsuario").value;
                if (texto == clave) {
                    let formData = new FormData(this);
                    let datosAEnviar = [];
                    formData.forEach((valor) => { datosAEnviar.push(valor); });
                    
                    datosAEnviar[0] = datosAEnviar[0].toLowerCase();
                    // datosAEnviar[1] es la nueva contraseña del input agregado
                    let urlFinal = URLUsuarios + "?correo=" + encodeURIComponent(datosAEnviar[0]) + "&contrasenia=" + encodeURIComponent(datosAEnviar[1]) + "&funcion=modificarContrasenia";
                    enviar(urlFinal);
                } else {
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: "Codigo incorrecto. Intente nuevamente. Respete Mayúsculas y Minúsculas.",
                        background: '#1a1a1a',
                        color: '#fff'
                    });
                }
            }
        });

        function enviarCodigo(urlFinal) {
            document.querySelector("body").style.cursor = "wait";
            document.querySelector("#botonEnviar").style.cursor = "wait";
            document.querySelector(".contenedorLoader").style.display = "flex";

            fetch(urlFinal)
            .then(response => {
                if (!response.ok) throw new Error('Error en la red');
                return response.json();
            })
            .then(res => {
                if (res.status == false) {
                    Swal.fire({
                        icon: "error",
                        title: "No encontrado",
                        text: "El correo no existe en nuestra base de datos.",
                        background: '#1a1a1a',
                        color: '#fff'
                    });
                } else if (res.status) {
                    Swal.fire({
                        title: "Código Enviado",
                        icon: "info",
                        text: "Revisa tu bandeja de entrada (y spam).",
                        confirmButtonColor: '#f3a661'
                    });
                    
                    document.querySelector(".codigo").style.display = "block";
                    document.querySelector("#botonEnviar").innerHTML = "Cambiar Contraseña";
                    document.getElementById('instruccion').innerText = "Ingresa la nueva contraseña y el código enviado.";
                }
            })
            .catch(error => {
                console.error(error);
                Swal.fire({ icon: "error", title: "Error", text: "No se pudo conectar con el servidor." });
            })
            .finally(() => {
                document.querySelector("body").style.cursor = "default";
                document.querySelector("#botonEnviar").style.cursor = "pointer";
                document.querySelector(".contenedorLoader").style.display = "none";
            });
        }

        function generarCadenaAleatoria() {
            const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let resultado = '';
            for (let i = 0; i < 6; i++) {
                resultado += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
            }
            return resultado;
        }

        function enviar(urlFinal) {
            document.querySelector(".contenedorLoader").style.display = "flex";
            fetch(urlFinal).then(response => response.json())
            .then(data => {
                if (data.status) {
                    Swal.fire({
                        icon: "success",
                        title: "¡Éxito!",
                        text: "Contraseña actualizada correctamente.",
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = "Login.html";
                    });
                } else {
                    throw new Error();
                }
            })
            .catch(() => {
                Swal.fire({ icon: "error", title: "Error", text: "Error al cambiar la contraseña." });
            })
            .finally(() => {
                document.querySelector(".contenedorLoader").style.display = "none";
            });
        }
    </script>
</body>
</html>
