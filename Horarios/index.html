    <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reserva De Clase</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/precios.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #f3a661;
            --bg-dark: #0a0a0b;
            --glass: rgba(20, 20, 22, 0.97);
            --border: rgba(255, 255, 255, 0.08);
            --available: rgba(243, 166, 97, 0.07);
            --danger: #ff5f5f;
        }

        /* Ajuste de prioridad para que SweetAlert esté sobre el sidebar */
        .swal2-container { z-index: 10000 !important; }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark) url('/Horarios/assets/fotos/fondo.avif') no-repeat center center fixed;
            background-size: cover; color: #fff; overflow: hidden; height: 100vh;
        }

        .swal-modal-light .swal2-popup { background: #ffffff !important; color: #000000 !important; }
        .swal-modal-light .swal2-title, .swal-modal-light .swal2-html-container { color: #000000 !important; }
        .swal-modal-light .swal2-radio { color: #000000 !important; display: flex !important; flex-direction: column !important; align-items: flex-start !important; padding-left: 20% !important; }

        /* Selector de modalidad */
        .mod-selector { display: flex; gap: 14px; flex-wrap: wrap; justify-content: center; margin: 8px 0 4px; }
        .mod-card {
            flex: 1; min-width: 140px; max-width: 200px;
            background: #f5f5f5; border: 2px solid #e0e0e0; border-radius: 14px;
            padding: 18px 14px; cursor: pointer; transition: all 0.2s ease;
            text-align: center; color: #333;
        }
        .mod-card:hover { border-color: var(--primary); background: rgba(243, 166, 97, 0.08); }
        .mod-card.selected { border-color: var(--primary); background: rgba(243, 166, 97, 0.15); box-shadow: 0 0 0 1px var(--primary); }
        .mod-card .mod-icon { font-size: 1.8rem; color: var(--primary); margin-bottom: 8px; }
        .mod-card .mod-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 4px; }
        .mod-card .mod-desc { font-size: 0.75rem; color: #666; margin-bottom: 8px; line-height: 1.3; }
        .mod-card .mod-price { font-size: 0.8rem; font-weight: 700; color: var(--primary); }
        .mod-card .mod-hint { font-size: 0.65rem; color: #999; margin-top: 2px; }

        .navbar { height: 65px; background: var(--glass); display: flex; justify-content: space-between; align-items: center; padding: 0 25px; border-bottom: 1px solid var(--border); backdrop-filter: blur(12px); z-index: 900; }
        .brand-title { font-weight: 700; color: var(--primary); letter-spacing: 1px; }
        .user-access { width: 40px; height: 40px; background: rgba(255,255,255,0.05); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--border); }

        #user-sidebar { position: fixed; top: 0; right: -350px; width: 350px; height: 100%; background: rgba(13, 13, 15, 0.98); backdrop-filter: blur(25px); z-index: 2000; transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1); border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        #user-sidebar.active { right: 0; }
        .sidebar-header { padding: 40px 25px 20px; text-align: center; }
        .profile-img { width: 60px; height: 60px; background: var(--primary); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; margin: 0 auto 10px; font-weight: 700; box-shadow: 0 0 15px rgba(243, 166, 97, 0.3); }
        .sidebar-content { padding: 10px 25px; flex-grow: 1; overflow-y: auto; }
        .info-card { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 10px; }
        .info-label { font-size: 0.65rem; color: var(--primary); font-weight: 700; text-transform: uppercase; margin-bottom: 4px; display: block; }
        
        .horario-tag { display: flex; align-items: center; background: rgba(243, 166, 97, 0.1); border: 1px solid rgba(243, 166, 97, 0.2); padding: 8px 12px; border-radius: 8px; margin-bottom: 6px; font-size: 0.75rem; color: #ddd; }
        .horario-tag i { color: var(--primary); margin-right: 10px; font-size: 0.8rem; }

        .sidebar-footer { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border-top: 1px solid var(--border); }
        .btn-footer { padding: 12px; border-radius: 8px; border: 1px solid #444; cursor: pointer; font-weight: 600; font-size: 0.7rem; text-transform: uppercase; transition: 0.2s; }
        .btn-close { background: #222; color: white; }
        .btn-logout { background: rgba(255, 95, 95, 0.1); color: var(--danger); border-color: rgba(255, 95, 95, 0.3); }
        .btn-logout:hover { background: var(--danger); color: white; }
        .btn-admin { grid-column: span 2; background: transparent; color: var(--primary); border: 1px dashed var(--primary); margin-top: 5px; }
        .btn-admin.active { background: var(--primary); color: black; border-style: solid; }

        .main-container { height: calc(100vh - 65px); padding: 10px; display: flex; flex-direction: column; }
        .calendar-card { background: var(--glass); border-radius: 16px; flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; margin-bottom: 85px; border: 1px solid var(--border); }
        .agenda-wrapper { display: flex; flex-grow: 1; }
        .hours-column { width: 50px; background: rgba(0,0,0,0.4); display: flex; flex-direction: column; }
        .hour-cell, .slot { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .days-container { display: flex; flex-grow: 1; width: calc(100% - 50px); }
        .day-column { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .day-header { height: 45px; border-bottom: 2px solid var(--primary); background: rgba(255,255,255,0.03); text-align: center; display: flex; flex-direction: column; justify-content: center; }

        .slot { margin: 1px; cursor: pointer; transition: 0.2s; background: var(--available); position: relative; }
        .slot.occupied { background: rgba(255,255,255,0.03); opacity: 0.4; cursor: not-allowed; }
        .slot.occupied::after { content: "\f023"; font-family: "Font Awesome 6 Free"; font-weight: 900; font-size: 0.7rem; color: rgba(255,255,255,0.4); }
        .slot.selected { background: var(--primary) !important; border: 1px solid #fff; box-shadow: 0 0 10px var(--primary); }

        .controls-overlay { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; gap: 10px; z-index: 1000; cursor: grab; user-select: none; }
        .controls-overlay.dragging { cursor: grabbing; }
        .controls-overlay .btn-week { cursor: pointer; }
        .controls-overlay .btn-reserve { cursor: pointer; }
        .week-selector { background: #151517; padding: 5px; border-radius: 12px; display: flex; border: 1px solid #333; }
        .week-selector.hint-mover { animation: barraSigueCursor 2.6s cubic-bezier(0.33, 1, 0.68, 1) 1; }
        @keyframes barraSigueCursor {
            0%, 28% { transform: translate(0, 0); box-shadow: 0 0 0 rgba(243, 166, 97, 0); }
            30% { transform: translate(0, 0); box-shadow: 0 0 0 rgba(243, 166, 97, 0); }
            35% { transform: translate(calc(var(--bar-drag-x) * 0.35), calc(var(--bar-drag-y) * 0.35)); box-shadow: 0 8px 20px rgba(0,0,0,0.3), 0 0 18px rgba(243, 166, 97, 0.25); }
            48% { transform: translate(var(--bar-drag-x), var(--bar-drag-y)); box-shadow: 0 12px 28px rgba(0,0,0,0.35), 0 0 22px rgba(243, 166, 97, 0.3); }
            50% { transform: translate(var(--bar-drag-x), var(--bar-drag-y)); box-shadow: 0 12px 28px rgba(0,0,0,0.35), 0 0 22px rgba(243, 166, 97, 0.3); }
            58% { transform: translate(0, 3px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
            68% { transform: translate(0, 0); box-shadow: 0 0 0 rgba(243, 166, 97, 0); }
            100% { transform: translate(0, 0); box-shadow: 0 0 0 rgba(243, 166, 97, 0); }
        }
        #dragDemoCursor { position: fixed; z-index: 1001; pointer-events: none; left: var(--drag-start-x, 50%); top: var(--drag-start-y, 90%); transform: translate(-50%, -50%); opacity: 0; color: var(--primary); font-size: 1.75rem; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.5)) drop-shadow(0 0 12px rgba(243, 166, 97, 0.4)); will-change: left, top, transform, opacity; }
        #dragDemoCursor.playing { animation: cursorDrag 2.6s cubic-bezier(0.33, 1, 0.68, 1) 1 forwards; }
        @keyframes cursorDrag {
            0% { left: var(--drag-start-x); top: var(--drag-start-y); opacity: 0; transform: translate(-50%, -50%) scale(0.7); }
            6% { left: var(--drag-start-x); top: var(--drag-start-y); opacity: 1; transform: translate(-50%, -50%) scale(1); }
            22% { left: var(--drag-start-x); top: var(--drag-start-y); opacity: 1; transform: translate(-50%, -50%) scale(1) rotate(0deg); }
            26% { left: var(--drag-start-x); top: var(--drag-start-y); opacity: 1; transform: translate(-50%, -50%) scale(0.88) rotate(-8deg); }
            35% { left: var(--drag-mid-x); top: var(--drag-mid-y); opacity: 1; transform: translate(-50%, -50%) scale(0.88) rotate(-8deg); }
            48% { left: var(--drag-end-x); top: var(--drag-end-y); opacity: 1; transform: translate(-50%, -50%) scale(0.88) rotate(-8deg); }
            50% { left: var(--drag-end-x); top: var(--drag-end-y); opacity: 1; transform: translate(-50%, -50%) scale(0.88) rotate(-8deg); }
            56% { left: var(--drag-end-x); top: var(--drag-end-y); opacity: 1; transform: translate(-50%, -50%) scale(1) rotate(0deg); }
            70% { left: var(--drag-end-x); top: var(--drag-end-y); opacity: 1; transform: translate(-50%, -50%) scale(1); }
            82% { left: var(--drag-end-x); top: var(--drag-end-y); opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            100% { left: var(--drag-end-x); top: var(--drag-end-y); opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        }
        .btn-week { background: transparent; border: none; color: #888; padding: 10px 18px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-week.active { background: var(--primary); color: #000; }
        .btn-reserve { width: 90%; background: var(--primary); color: #000; padding: 18px; border-radius: 15px; font-weight: 800; border: none; display: none; }

        #userHintCursor { position: fixed; z-index: 1001; pointer-events: none; left: var(--hint-start-x, 20%); top: var(--hint-start-y, 20%); transform: translate(-50%, -50%); opacity: 0; color: var(--primary); font-size: 1.6rem; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.5)) drop-shadow(0 0 12px rgba(243, 166, 97, 0.4)); will-change: left, top, transform, opacity; }
        #userHintCursor.playing { animation: cursorClickUser 2.2s cubic-bezier(0.33, 1, 0.68, 1) 1 forwards; }
        @keyframes cursorClickUser {
            0% { left: var(--hint-start-x); top: var(--hint-start-y); opacity: 0; transform: translate(-50%, -50%) scale(0.7); }
            8% { left: var(--hint-start-x); top: var(--hint-start-y); opacity: 1; transform: translate(-50%, -50%) scale(1); }
            45% { left: var(--hint-target-x); top: var(--hint-target-y); opacity: 1; transform: translate(-50%, -50%) scale(1); }
            52% { left: var(--hint-target-x); top: var(--hint-target-y); opacity: 1; transform: translate(-50%, -50%) scale(0.82); }
            60% { left: var(--hint-target-x); top: var(--hint-target-y); opacity: 1; transform: translate(-50%, -50%) scale(1); }
            75% { left: var(--hint-target-x); top: var(--hint-target-y); opacity: 1; transform: translate(-50%, -50%) scale(1); }
            88% { left: var(--hint-target-x); top: var(--hint-target-y); opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            100% { left: var(--hint-target-x); top: var(--hint-target-y); opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        }
        .user-access.hint-destacado { animation: userIconPulse 0.5s ease-out 1; }
        @keyframes userIconPulse {
            0%, 100% { box-shadow: 0 0 0 rgba(243, 166, 97, 0); }
            50% { box-shadow: 0 0 0 4px rgba(243, 166, 97, 0.5), 0 0 20px rgba(243, 166, 97, 0.3); }
        }

        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 5000; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(243, 166, 97, 0.1); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader-overlay"><div class="spinner"></div><p id="loader-text" style="margin-top:15px; color:var(--primary);">Cargando horarios...</p></div>
    <div id="dragDemoCursor" aria-hidden="true"><i class="fa-solid fa-hand"></i></div>
    <div id="userHintCursor" aria-hidden="true"><i class="fa-solid fa-hand"></i></div>

    <div id="user-sidebar">
        <div class="sidebar-header">
            <div class="profile-img" id="user-initial">?</div>
            <h2 id="sb-nombre-completo">-</h2>
            <p id="sb-correo" style="font-size: 0.8rem; opacity: 0.6;"></p>
        </div>
        <div class="sidebar-content">
            <div class="info-card"><span class="info-label">Deuda Actual</span><div class="info-value" id="sb-deuda"></div></div>
            <div class="info-card"><span class="info-label">Horas a Favor</span><div class="info-value" id="sb-horas"></div></div>
            <div class="info-card" style="border:none; background:transparent; padding:5px 0;">
                <span class="info-label">Mis Horarios Reservados</span>
                <div id="sb-lista-horarios"></div>
            </div>
        </div>
        <div class="sidebar-footer">
            <button class="btn-footer btn-admin" id="adminToggle" onclick="toggleAdmin()">Modo Admin</button>
            <button class="btn-footer btn-close" onclick="toggleSidebar()">cerrar menu</button>
            <button class="btn-footer btn-logout" onclick="logout()">cerrar sesion</button>
        </div>
    </div>

    <nav class="navbar"><div class="brand-title">Reserva de Horarios</div><div class="user-access" id="userAccessBtn" onclick="toggleSidebar()"><i class="fa-solid fa-user"></i></div></nav>

    <div class="main-container">
        <div class="calendar-card">
            <div class="agenda-wrapper">
                <div class="hours-column" id="hoursCol"></div>
                <div class="days-container" id="daysContainer"></div>
            </div>
        </div>
    </div>

    <div class="controls-overlay" id="controlsOverlay">
        <div class="week-selector">
            <button class="btn-week active" id="btnW0" onclick="changeWeek(0)">ESTA SEMANA</button>
            <button class="btn-week" id="btnW1" onclick="changeWeek(1)">PRÓXIMA SEMANA</button>
        </div>
        <button class="btn-reserve" id="btnConfirm" onclick="gestionarReserva()">Confirmar Reserva</button>
    </div>

    <script>
        const URLHorarios = "https://script.google.com/macros/s/AKfycbxR8IoHxqiJRlt8eOsQsu57b6yjOPfSwDJdVCt_dX6JzxbWGS4r2SOhaI_uVafWKNc/exec"; 
        const URLUsuarios = "https://script.google.com/macros/s/AKfycbwvSTFpClvlYupAvfgpR7YTvd90x7AN0t4EJZ5x7xarJ-ga1wRtWxNTDDy-Wm4judEX/exec"; 
let Alumno = JSON.parse(sessionStorage.getItem("persona"));
        
        // Si no hay sesión, mostrar menú de acceso
        if (!Alumno) {
            Swal.fire({
                title: '¡Bienvenido!',
                text: 'Para reservar un horario primero debes ingresar a tu cuenta.',
                icon: 'info',
                background: '#151517',
                color: '#fff',
                showCancelButton: true,
                confirmButtonText: '<i class="fa-solid fa-right-to-bracket"></i> Iniciar Sesión',
                cancelButtonText: '<i class="fa-solid fa-user-plus"></i> Registrarse',
                confirmButtonColor: '#f3a661',
                cancelButtonColor: '#222',
                allowOutsideClick: false,
                allowEscapeKey: false,
                customClass: {
                    confirmButton: 'btn-footer',
                    cancelButton: 'btn-footer'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/Horarios/Login/Login.html';
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    // Cambia esta ruta si tu archivo de registro se llama distinto
                    window.location.href = '/Horarios/Registro/Registro.html'; 
                }
            });
            
            // Definimos un objeto Alumno vacío temporal para evitar errores de lectura 
            // en el resto del script antes de que cambie la página
            Alumno = { nombre: "", cantidadDebe: 0, horarios: [] };
        }
        let weekOffset = 0, selectedSlots = [], cacheHorarios = { 0: null, 1: null };
        let isAdmin = false;
        let yaMostroHintMoverBarra = false;
        let yaMostroHintUser = false;

        function mostrarHintUserIcon() {
            if (yaMostroHintUser) return;
            yaMostroHintUser = true;
            const cursor = document.getElementById('userHintCursor');
            const icon = document.getElementById('userAccessBtn');
            if (!cursor || !icon) return;
            const rect = icon.getBoundingClientRect();
            const targetX = rect.left + rect.width / 2;
            const targetY = rect.top + rect.height / 2;
            const startX = Math.min(window.innerWidth * 0.22, targetX - 80);
            const startY = window.innerHeight * 0.22;
            cursor.style.setProperty('--hint-start-x', startX + 'px');
            cursor.style.setProperty('--hint-start-y', startY + 'px');
            cursor.style.setProperty('--hint-target-x', targetX + 'px');
            cursor.style.setProperty('--hint-target-y', targetY + 'px');
            cursor.classList.remove('playing');
            cursor.offsetHeight;
            cursor.classList.add('playing');
            cursor.removeAttribute('aria-hidden');
            setTimeout(() => {
                if (icon) {
                    icon.classList.add('hint-destacado');
                    setTimeout(() => icon.classList.remove('hint-destacado'), 600);
                }
            }, 1150);
            const quitarAnim = () => {
                cursor.classList.remove('playing');
                cursor.setAttribute('aria-hidden', 'true');
                cursor.removeEventListener('animationend', quitarAnim);
            };
            cursor.addEventListener('animationend', quitarAnim);
        }

        function mostrarHintMoverBarra() {
            if (yaMostroHintMoverBarra) return;
            yaMostroHintMoverBarra = true;
            const barra = document.querySelector('#controlsOverlay .week-selector');
            const cursor = document.getElementById('dragDemoCursor');
            if (!barra || !cursor) return;
            const rect = barra.getBoundingClientRect();
            const startX = rect.left + rect.width / 2;
            const startY = rect.top + rect.height / 2;
            const dragX = 100, dragY = -22;
            const endX = startX + dragX, endY = startY + dragY;
            const midX = startX + dragX * 0.35, midY = startY + dragY * 0.35;
            cursor.style.setProperty('--drag-start-x', startX + 'px');
            cursor.style.setProperty('--drag-start-y', startY + 'px');
            cursor.style.setProperty('--drag-mid-x', midX + 'px');
            cursor.style.setProperty('--drag-mid-y', midY + 'px');
            cursor.style.setProperty('--drag-end-x', endX + 'px');
            cursor.style.setProperty('--drag-end-y', endY + 'px');
            barra.style.setProperty('--bar-drag-x', dragX + 'px');
            barra.style.setProperty('--bar-drag-y', dragY + 'px');
            barra.classList.remove('hint-mover');
            cursor.classList.remove('playing');
            barra.offsetHeight;
            cursor.offsetHeight;
            barra.classList.add('hint-mover');
            cursor.classList.add('playing');
            cursor.removeAttribute('aria-hidden');
            const quitarAnim = () => {
                barra.classList.remove('hint-mover');
                cursor.classList.remove('playing');
                cursor.setAttribute('aria-hidden', 'true');
                barra.removeEventListener('animationend', quitarAnim);
            };
            barra.addEventListener('animationend', quitarAnim);
        }

        function ocultarHintMoverBarra() {
            const barra = document.querySelector('#controlsOverlay .week-selector');
            const cursor = document.getElementById('dragDemoCursor');
            if (barra) barra.classList.remove('hint-mover');
            if (cursor) { cursor.classList.remove('playing'); cursor.setAttribute('aria-hidden', 'true'); }
        }

        const AVISO_PACK_KEY = 'avisoPackTerminadoFecha';

        function mostrarAvisoPackTerminadoSiCorresponde() {
            if (!Alumno || !Alumno.correoElectronico) return;
            const fechaPago = Alumno.fechaPago;
            const horasAFavor = Alumno.horasAFavor;
            if (fechaPago == null || fechaPago === '' || horasAFavor != 0) return;
            if (localStorage.getItem(AVISO_PACK_KEY) === String(fechaPago)) return;
            localStorage.setItem(AVISO_PACK_KEY, String(fechaPago));
            Swal.fire({
                icon: 'info',
                title: 'Pack de horas finalizado',
                text: 'Tu pack de horas ha terminado. Deberás abonar la clase individualmente.',
                background: '#151517',
                color: '#fff',
                confirmButtonColor: '#f3a661'
            });
        }

        async function init() {
            document.getElementById('loader-overlay').style.display = 'flex';
            if (Alumno && Alumno.correoElectronico && Alumno.contrasenia) {
                await actualizarDatos(Alumno.correoElectronico, Alumno.contrasenia);
            }
            if(Alumno.admin === true) {
                isAdmin = true;
                const btnAdmin = document.getElementById('adminToggle');
                btnAdmin.innerText = "MODO ADMIN ACTIVO";
                btnAdmin.classList.add('active');
            }

            const hCol = document.getElementById('hoursCol');
            hCol.innerHTML = '<div style="height:45px"></div>';
            for (let h = 8; h <= 19; h++) hCol.innerHTML += `<div class="hour-cell">${h}:00</div>`;
            await Promise.all([fetchSemana(0), fetchSemana(1)]);
            render();
            document.getElementById('loader-overlay').style.display = 'none';
            setTimeout(() => { if (!yaMostroHintUser) mostrarHintUserIcon(); }, 500);
        }

        async function actualizarDatos(correo, contrasenia) {
            let urlFinal = `${URLUsuarios}?correo=${correo}&contrasenia=${contrasenia}&funcion=validarUsuario`;
            try {
                const response = await fetch(urlFinal);
                const data = await response.json();
                if (data.sesion) {
                    Alumno = data;
                    sessionStorage.setItem('persona', JSON.stringify(data));
                    actualizarInterfazSidebar();
                }
            } catch (error) { console.error('Error:', error); }
        }

        function actualizarInterfazSidebar() {
            document.getElementById('user-initial').innerText = Alumno.nombre.charAt(0).toUpperCase();
            document.getElementById('sb-nombre-completo').innerText = `${Alumno.nombre} ${Alumno.apellido}`;
            document.getElementById('sb-correo').innerText = Alumno.correoElectronico;
            document.getElementById('sb-deuda').innerText = Alumno.dineroQueDebe;
            document.getElementById('sb-horas').innerText = Alumno.horasAFavor + " hs";
            const container = document.getElementById('sb-lista-horarios');
            container.innerHTML = Alumno.horarios?.length > 0 
                ? Alumno.horarios.map(h => `<div class="horario-tag"><i class="fa-regular fa-calendar-check"></i> ${h}</div>`).join('')
                : '<p style="font-size:0.7rem; opacity:0.5; padding-left:5px;">Sin turnos reservados.</p>';
        }

        async function toggleAdmin() {
            if(isAdmin) {
                isAdmin = false;
                document.getElementById('adminToggle').innerText = "Habilitar Admin";
                document.getElementById('adminToggle').classList.remove('active');
                return;
            }
            const { value: pass } = await Swal.fire({ 
                title: 'Contraseña Admin', 
                input: 'password', 
                confirmButtonColor: '#f3a661'
            });
            if (pass === 'admin123') {
                isAdmin = true;
                document.getElementById('adminToggle').innerText = "MODO ADMIN ACTIVO";
                document.getElementById('adminToggle').classList.add('active');
            } else if (pass) {
                Swal.fire({ icon: 'error', title: 'Incorrecta' });
            }
        }

        function logout() { sessionStorage.clear(); window.location.href = '/Horarios/Login/Login.html'; }

        async function fetchSemana(off) {
            try {
                const res = await fetch(`${URLHorarios}?funcion=celdasOcupadas&numeroHoja=${off}`);
                const data = await res.json();
                cacheHorarios[off] = data[1];
            } catch (e) { cacheHorarios[off] = []; }
        }

        function render() {
            const container = document.getElementById('daysContainer');
            container.innerHTML = '';
            const now = new Date();
            const limit12 = new Date(now.getTime() + (12 * 60 * 60 * 1000));
            const monday = new Date(now);
            // Si hoy es domingo, "semana actual" = próxima semana (desde el lunes); si no, lunes de esta semana
            const daysToMonday = (now.getDay() === 0) ? 1 : (1 - now.getDay());
            monday.setDate(now.getDate() + daysToMonday + (weekOffset * 7));
            monday.setHours(0,0,0,0);

            const celdasOcupadas = cacheHorarios[weekOffset] || [];
            const letras = ['B', 'C', 'D', 'E', 'F'];
            const nombresDias = ['LUN', 'MAR', 'MIE', 'JUE', 'VIE'];

            letras.forEach((letra, i) => {
                const colDate = new Date(monday);
                colDate.setDate(monday.getDate() + i);
                const isoDate = colDate.toISOString().split('T')[0];
                const col = document.createElement('div');
                col.className = 'day-column';
                col.innerHTML = `<div class="day-header"><span style="font-size:0.6rem; color:var(--primary); font-weight:800">${nombresDias[i]}</span><span style="font-size:0.7rem">${colDate.getDate()}/${(colDate.getMonth()+1).toString().padStart(2,'0')}</span></div>`;

                for (let h = 8; h <= 19; h++) {
                    const fullId = `${isoDate} ${h.toString().padStart(2, '0')}:00`;
                    const slotTime = new Date(`${isoDate}T${h.toString().padStart(2, '0')}:00:00`);
                    const isOccupied = celdasOcupadas.includes(`${letra}${h-5}`);
                    const slot = document.createElement('div');
                    slot.className = `slot ${isOccupied ? 'occupied' : ''} ${selectedSlots.includes(fullId) ? 'selected' : ''}`;
                    
                    slot.onclick = () => {
                        mostrarAvisoPackTerminadoSiCorresponde();
                        if (isOccupied && !isAdmin) return Swal.fire({ icon: 'error', title: 'Turno Ocupado', text: 'Esta hora ya ha sido reservada.', background: '#1a1a1a', color: '#fff' });
                        if (!isAdmin && selectedSlots.length > 0) {
                            const primerDia = selectedSlots[0].split(' ')[0];
                            if (isoDate !== primerDia) return Swal.fire({ icon: 'warning', title: 'Un día a la vez', text: 'Solo puedes elegir horas del mismo día.', background: '#1a1a1a', color: '#fff' });
                        }
                        if (!isAdmin && slotTime < limit12) {
                            return Swal.fire({ icon: 'info', title: 'Plazo de anticipación', html: 'Las reservas deben realizarse con un <b>mínimo de 12 horas de antelación</b>.', background: '#1a1a1a', color: '#fff' });
                        }
                        if (selectedSlots.includes(fullId)) {
                            selectedSlots = selectedSlots.filter(s => s !== fullId);
                            slot.classList.remove('selected');
                            if (selectedSlots.length === 0) ocultarHintMoverBarra();
                        } else {
                            selectedSlots.push(fullId);
                            slot.classList.add('selected');
                            if (selectedSlots.length === 1 && !yaMostroHintMoverBarra) mostrarHintMoverBarra();
                        }
                        const btn = document.getElementById('btnConfirm');
                        btn.style.display = selectedSlots.length > 0 ? 'block' : 'none';
                        btn.innerText = `RESERVAR (${selectedSlots.length})`;
                    };
                    col.appendChild(slot);
                }
                container.appendChild(col);
            });
        }

        function calcularMensaje(data) {
            let msg = "";
            if (data.faltantes) {
                let textoFaltantes = Array.isArray(data.faltantes) ? data.faltantes.join(', ') : data.faltantes;
                msg += `<br>${textoFaltantes}<br><br>`;
            }
            if (data.deudores) {
                let textoDeudores = Array.isArray(data.deudores) ? data.deudores.join(', ') : data.deudores;
                msg += `<br>${textoDeudores}`;
            }
            return msg;
        }

async function gestionarReserva() {
            // --- NUEVA RESTRICCIÓN: cantidadDebe ---
            // Se usa el string hexadecimal directamente para evitar errores de sintaxis
            if (!isAdmin && (Alumno.condicionPago != "Libre" && Alumno.cantidadDebe >= 2)) {
                return Swal.fire({
                    icon: 'error',
                    title: 'Acceso Denegado',
                    text: 'No puedes reservar nuevos horarios porque tienes 2 o más clases pendientes de pago.',
                    background: '#1a1a1a',
                    color: '#fff',
                    confirmButtonColor: '#ff5f5f' 
                });
            }

            if (!isAdmin && Alumno.horarios?.length >= 2) return Swal.fire({ icon: 'error', title: 'Límite de Reservas', text: 'Solo puedes tener 2 reservas activas. Si quieres mas, comunicate por whatsapp' });

            const nHoras = selectedSlots.length;
            const precioInd = (nHoras === 1 ? PRECIOS.individual.precioPorHora1 : PRECIOS.individual.precioPorHora2) * nHoras;
            const precioGrpHora = PRECIOS.grupal.precioPorHora * nHoras;

            const htmlModalidad = `
                <input type="hidden" id="modValue" value="" />
                <div class="mod-selector">
                    <div class="mod-card" data-mod="individual" id="card-individual">
                        <div class="mod-icon"><i class="fa-solid fa-user"></i></div>
                        <div class="mod-title">Individual</div>
                        <div class="mod-desc">Clase solo para vos</div>
                        <div class="mod-price">$${precioInd}</div>
                        <div class="mod-hint">${nHoras} ${nHoras === 1 ? 'hora' : 'horas'} seleccionada${nHoras > 1 ? 's' : ''}</div>
                    </div>
                    <div class="mod-card" data-mod="grupal" id="card-grupal">
                        <div class="mod-icon"><i class="fa-solid fa-users"></i></div>
                        <div class="mod-title">Grupal</div>
                        <div class="mod-desc">Varios integrantes, precio por persona</div>
                        <div class="mod-price">$${precioGrpHora} c/u</div>
                        <div class="mod-hint">Mín. 2 horas · desde 2 personas</div>
                    </div>
                </div>
            `;

            const { value: mod } = await Swal.fire({
                title: 'Elegí la modalidad',
                html: htmlModalidad,
                customClass: { container: 'swal-modal-light' },
                showCancelButton: true,
                cancelButtonText: 'Cancelar',
                confirmButtonText: 'Continuar',
                confirmButtonColor: '#f3a661',
                preConfirm: () => {
                    const v = document.getElementById('modValue').value;
                    if (!v) { Swal.showValidationMessage('Elegí una opción'); return false; }
                    return v;
                },
                didOpen: () => {
                    const cards = document.querySelectorAll('.mod-card');
                    cards.forEach(card => {
                        card.addEventListener('click', () => {
                            cards.forEach(c => c.classList.remove('selected'));
                            card.classList.add('selected');
                            document.getElementById('modValue').value = card.dataset.mod;
                        });
                    });
                }
            });

            if (!mod) return;
            if (!isAdmin && mod === 'grupal' && selectedSlots.length < 2) return Swal.fire({ icon: 'warning', title: 'Atención', text: 'Mínimo 2 horas para grupales.' });

            let integrantes = [Alumno.correoElectronico]; 
            let precioTotal = (selectedSlots.length === 1 ? PRECIOS.individual.precioPorHora1 : PRECIOS.individual.precioPorHora2) * selectedSlots.length;
            let precioPorPersona = precioTotal;

            if (mod === 'grupal') {
                const { value: cant } = await Swal.fire({
                    title: 'Numero de Integrantes',
                    html:'Cantidad incluyendote',
                    input: 'number',
                    inputAttributes: { min: 2 },
                    confirmButtonColor: '#f3a661'
                });

                if (!cant) return;

                const numIntegrantes = Math.max(2, parseInt(cant, 10) || 2);

                for (let i = 1; i < numIntegrantes; i++) {

                    const { value: email } = await Swal.fire({
                        title: `Email integrante ${i+1}`,
                        input: 'email',
                        confirmButtonColor: '#f3a661',
                        inputValidator: (value) => {
                            console.log(value);
                            if (!value) {
                                return 'Debes ingresar un correo';
                            }

                            if (value === Alumno.correoElectronico) {
                                return 'No puedes ingresar tu propio correo como integrante';
                            }

                            if (integrantes.includes(value)) {
                                return 'Ese correo ya fue ingresado';
                            }

                            return null;
                        }
                    });

                    if (!email) return;

                    integrantes.push(email);
                }


                // Validación de correos (integrantes registrados y sin deuda) siempre, también en modo admin
                document.getElementById('loader-overlay').style.display = 'flex';
                document.getElementById('loader-text').textContent = 'Validando integrantes...';
                try {
                    const urlVerif = `${URLUsuarios}?funcion=verificarCorreos&correos=${encodeURIComponent(JSON.stringify(integrantes))}`;
                    const resVerif = await fetch(urlVerif);
                    const dataVerif = await resVerif.json();
                    if (dataVerif.error && dataVerif.error !== false) {
                        document.getElementById('loader-overlay').style.display = 'none';
                        return Swal.fire({ icon: 'error', title: dataVerif.faltantes ? 'Verificar Integrantes' : 'Deuda Pendiente', html: calcularMensaje(dataVerif) });
                    }
                } catch (err) {
                    document.getElementById('loader-overlay').style.display = 'none';
                    return Swal.fire({ icon: 'error', title: 'Error de conexión', text: 'No se pudo validar los correos.' });
                } finally {
                    document.getElementById('loader-overlay').style.display = 'none';
                }
                precioPorPersona = PRECIOS.grupal.precioPorHora * selectedSlots.length;
                precioTotal = precioPorPersona * integrantes.length;
            }

            const letras = ['B', 'C', 'D', 'E', 'F'], diasNombres = ['lunes', 'martes', 'miércoles', 'jueves', 'viernes'];
            const [fecha0, hora0] = selectedSlots[0].split(' ');
            const d0 = new Date(fecha0 + 'T00:00:00');
            const diaNombre = diasNombres[d0.getDay() - 1].charAt(0).toUpperCase() + diasNombres[d0.getDay() - 1].slice(1);
            const fechaStr = `${d0.getDate()}/${(d0.getMonth()+1).toString().padStart(2,'0')}`;
            const horas = selectedSlots.map(id => id.split(' ')[1]).sort();
            const horaInicio = horas[0];
            const horaFinSlot = horas[horas.length - 1];
            const horaFinHasta = horaFinSlot.replace(':00', ':59');
            const textoRango = horaInicio === horaFinSlot
                ? `a las ${horaInicio} hs`
                : `de ${horaInicio} a ${horaFinHasta} hs`;
            const textoResumen = `${diaNombre} ${fechaStr} ${textoRango} · Modalidad ${mod === 'individual' ? 'Individual' : 'Grupal'}${mod === 'grupal' ? ` (${integrantes.length} integrantes)` : ''}`;

            const htmlConfirmacion = `
                <div style="text-align: left; font-size: 0.95rem; color: #333;">
                    <p style="margin: 0; padding: 12px 14px; background: rgba(243, 166, 97, 0.12); border-radius: 10px; border-left: 4px solid #f3a661; line-height: 1.5;">
                        <b>Resumen de la reserva</b><br>
                        <span style="margin-top: 6px; display: inline-block;">${textoResumen}</span>
                    </p>
                </div>
            `;

            const result = await Swal.fire({
                title: 'Confirmar Reserva',
                html: htmlConfirmacion,
                showCancelButton: true,
                confirmButtonText: 'Confirmar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#f3a661',
                customClass: { container: 'swal-modal-light' }
            });

            if (result.isConfirmed) {
                document.getElementById('loader-overlay').style.display = 'flex';
                document.getElementById('loader-text').textContent = 'Asignando horario...';
                
                const celdasExcel = [], nuevosHorarios = [...(Alumno.horarios || [])];
                selectedSlots.forEach(id => {
                    const [fecha, hora] = id.split(' ');
                    const d = new Date(fecha + 'T00:00:00');
                    celdasExcel.push(`${letras[d.getDay()-1]}${parseInt(hora)-5}`);
                    nuevosHorarios.push(`${diasNombres[d.getDay()-1]}, ${d.getDate()}/${d.getMonth()+1} ${parseInt(hora)}:00`);
                });

                const payload = { "persona": { ...Alumno, "horarios": nuevosHorarios }, "funcion": "asignarHorario", "celdas": celdasExcel, "numeroHoja": weekOffset, "metodoDePago": "", "integrantes": integrantes, "precio": precioPorPersona, "nombre": Alumno.nombre };

                try {
                    await fetch(URLUsuarios, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                    document.getElementById('loader-text').textContent = 'Reservando celdas en grilla...';
                    await fetch(URLHorarios, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ funcion: "reservarHorario", celdas: celdasExcel, numeroHoja: weekOffset, nombre: Alumno.nombre }) });
                    document.getElementById('loader-overlay').style.display = 'none';
                    await Swal.fire({ icon: 'success', title: 'Reserva completada', html: '<span style="color: #ff5f5f; font-weight: 600;">Por favor, revise su correo electrónico</span>', confirmButtonColor: '#f3a661' });
                    location.reload();
                } catch (e) {
                    document.getElementById('loader-overlay').style.display = 'none';
                    Swal.fire({ icon: 'error', title: 'Error de red' });
                }
            }
        }

        function changeWeek(off) {
            weekOffset = off; selectedSlots = [];
            ocultarHintMoverBarra();
            document.getElementById('btnConfirm').style.display = 'none';
            document.querySelectorAll('.btn-week').forEach(btn => btn.classList.remove('active'));
            document.getElementById(off === 0 ? 'btnW0' : 'btnW1').classList.add('active');
            render();
        }

        function toggleSidebar() { document.getElementById('user-sidebar').classList.toggle('active'); }

        (function setupControlsDrag() {
            const overlay = document.getElementById('controlsOverlay');
            const DRAG_THRESHOLD = 6;
            let dragging = false, maybeDragging = false, justDragged = false, startX, startY, startLeft, startTop;

            function startDrag(e) {
                maybeDragging = true;
                dragging = false;
                justDragged = false;
                startX = e.clientX ?? e.touches[0].clientX;
                startY = e.clientY ?? e.touches[0].clientY;
                const rect = overlay.getBoundingClientRect();
                startLeft = rect.left;
                startTop = rect.top;
                document.addEventListener('mousemove', move);
                document.addEventListener('mouseup', endDrag);
                document.addEventListener('touchmove', move, { passive: false });
                document.addEventListener('touchend', endDrag);
            }

            function move(e) {
                if (!maybeDragging) return;
                const x = e.clientX ?? (e.touches && e.touches[0].clientX);
                const y = e.clientY ?? (e.touches && e.touches[0].clientY);
                const dx = x - startX, dy = y - startY;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (!dragging && dist > DRAG_THRESHOLD) {
                    dragging = true;
                    overlay.classList.add('dragging');
                    overlay.style.left = startLeft + 'px';
                    overlay.style.top = startTop + 'px';
                    overlay.style.bottom = 'auto';
                    overlay.style.transform = 'none';
                }
                if (dragging) {
                    e.preventDefault();
                    const newLeft = Math.max(0, Math.min(window.innerWidth - overlay.offsetWidth, startLeft + dx));
                    const newTop = Math.max(0, Math.min(window.innerHeight - overlay.offsetHeight, startTop + dy));
                    overlay.style.left = newLeft + 'px';
                    overlay.style.top = newTop + 'px';
                    startLeft = newLeft;
                    startTop = newTop;
                    startX = x;
                    startY = y;
                }
            }

            function endDrag(e) {
                if (maybeDragging && dragging && e) {
                    e.preventDefault();
                    e.stopPropagation();
                    justDragged = true;
                }
                maybeDragging = false;
                dragging = false;
                overlay.classList.remove('dragging');
                document.removeEventListener('mousemove', move);
                document.removeEventListener('mouseup', endDrag);
                document.removeEventListener('touchmove', move, { passive: false });
                document.removeEventListener('touchend', endDrag);
            }

            overlay.addEventListener('click', function(e) {
                if (justDragged) {
                    e.preventDefault();
                    e.stopPropagation();
                    justDragged = false;
                }
            }, true);

            overlay.addEventListener('mousedown', startDrag);
            overlay.addEventListener('touchstart', startDrag, { passive: true });
        })();

        init();
    </script>
</body>
</html>
