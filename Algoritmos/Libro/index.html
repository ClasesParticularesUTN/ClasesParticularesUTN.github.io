<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">

<!-- âœ… NECESARIO PARA MOBILE -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Visor de CapÃ­tulos PDF</title>

<!-- âœ… SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- âœ… PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
</script>

<style>

  body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    background: #f5f5f5;
    overflow: hidden;
  }

  /* ===== MENU (BASE) ===== */
  #menu {
    background: #111;
    color: #fff;
    padding: 15px;
    overflow-y: auto;
    box-sizing: border-box;
    transition: transform 0.3s ease;
    z-index: 200;
  }

  #menu h2 {
    text-align:center;
    margin-top: 0;
  }

  .item-pdf {
    background: #222;
    margin-bottom: 10px;
    padding: 14px;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: .25s;
    border:1px solid #333;
    user-select: none;
  }

  .item-pdf:hover {
    background:#333;
    transform:scale(1.03);
  }

  /* ===== VISOR ===== */

  #visorArea {
    width: 100vw;
    height: 100vh;
    position: relative;
    display: flex;
    flex-direction: column;
    background:#f5f5f5;
    overflow: hidden;
  }

  #visor {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;

    width: 100vw;
    box-sizing: border-box;
  }

  canvas {
    border:1px solid #aaa;
    background:white;
    max-width:100%;
    height:auto;
  }

  #toggleMenuBtn {
    position: absolute;
    top: 15px;
    left: 15px;
    background: #222;
    color: #fff;
    border: none;
    font-size: 16px;
    border-radius: 6px;
    padding: 7px 12px;
    cursor: pointer;
    z-index: 300;
  }

  #placeholder {
    color:#555;
    font-size:20px;
    margin-top:50px;
  }


  /* ===== âœ… MOBILE ===== */
  @media (max-width: 800px) {

    #menu {
      width: 80vw;
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      transform: translateX(-100%);   /* inicio: oculto */
    }

    #menu.oculto {
      transform: translateX(-100%);
    }

    #menu.mostrar {
      transform: translateX(0);
    }

    canvas {
      max-width: 100vw !important;
    }
  }


  /* ===== âœ… DESKTOP ===== */
  @media (min-width: 801px) {

    body{
      display:flex;
    }

    #menu {
      width: 300px;
      position: relative;
      transform: translateX(0);
    }

    #menu.oculto {
      transform: translateX(0);
    }

    #toggleMenuBtn {
      display:none;
    }

    #visorArea {
      flex:1;
    }

    #visor {
      width:100%;
      padding:20px;
    }

    canvas {
      max-width:800px; /* tamaÃ±o ideal desktop */
    }
  }

</style>

</head>
<body>

<!-- MENU -->
<div id="menu" class="oculto">
  <h2>CapÃ­tulos</h2>
  <div id="lista"></div>
</div>

<!-- VISOR -->
<div id="visorArea">
  <button id="toggleMenuBtn">â˜° MenÃº</button>
  <div id="visor">
    <div id="placeholder">ðŸ“„ SeleccionÃ¡ un capÃ­tulo</div>
  </div>
</div>

<script>
/* ===========================
      LISTA DE PDFs
=========================== */
const pdfs = [
  "Capitlo 1.pdf",
  "Capitulo 2.pdf",
  "Capitulo 3.pdf",
  "Estructuras De Seleccion.pdf",
  "Estructuras de repeticion.pdf",
  "Funciones.pdf",
  "Arreglos.pdf",
  "Strings.pdf",
  "Structs.pdf",
  "Punteros.pdf",
  "Archivos.pdf",
];

const menu = document.getElementById("menu");
const lista = document.getElementById("lista");
const visor = document.getElementById("visor");

let currentTask = null;
let currentPdf  = null;

/* construir menÃº */
pdfs.forEach(nombre => {
  const d = document.createElement("div");
  d.className = "item-pdf";
  d.textContent = nombre.replace(/\.pdf$/,"");
  d.onclick = ()=>abrirPDF(nombre);
  lista.appendChild(d);
});


async function limpiarPDF(){
  try{ if(currentTask) await currentTask.destroy(); }catch{}
  try{ if(currentPdf) await currentPdf.destroy(); }catch{}
  currentTask=null;
  currentPdf=null;
  visor.innerHTML="";
}


/* ========= MENU ========= */
function ocultarMenu(){
  menu.classList.add("oculto");
  menu.classList.remove("mostrar");
}

function mostrarMenu(){
  menu.classList.add("mostrar");
  menu.classList.remove("oculto");
}

document.getElementById("toggleMenuBtn").onclick = ()=>{
  if(menu.classList.contains("oculto")){
    mostrarMenu();
  } else {
    ocultarMenu();
  }
};



/* ========= PDF ========= */
async function abrirPDF(nombre){
  ocultarMenu();
  await limpiarPDF();

  visor.innerHTML = `<div id="placeholder">Cargando...</div>`;

  const url = `Capitulo/${nombre}`;
  const loadingTask = pdfjsLib.getDocument({
    url,
    disableAutoFetch:true,
    disableStream:true
  });
  currentTask = loadingTask;

  const pdf = await loadingTask.promise;
  currentPdf = pdf;

  visor.innerHTML = "";
  renderAll(pdf);
}


async function renderAll(pdf){
  const total = pdf.numPages;

  /* âœ… scale responsive */
  const scale = window.innerWidth <= 800 ? 1.1 : 1.35;

  for(let i=1;i<=total;i++){
    if(currentPdf!==pdf) return;

    const page = await pdf.getPage(i);
    const vp = page.getViewport({scale});

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width  = vp.width;
    canvas.height = vp.height;

    visor.appendChild(canvas);
    await page.render({canvasContext:ctx, viewport:vp}).promise;
  }
}
</script>


<!-- âœ… VALIDAR USUARIO -->
<script>
(function validarAcceso(){

  const alumnoStr = sessionStorage.getItem("persona");

  if(!alumnoStr){
    window.location.href="/Horarios/Login/Login.html";
    return;
  }

  const alumno = JSON.parse(alumnoStr);

  const correosPermitidos=[
    "valedasilvacatela.vdc@gmail.com",
    "solmaina@gmail.com",
    "pazantivero01@gmail.com",
    "renzomercanti2005@gmail.com"
  ];

  const permitido = correosPermitidos.includes(
    (alumno.correoElectronico||"").toLowerCase()
  );

  if(!permitido){
    Swal.fire({
      icon:"error",
      title:"Acceso denegado",
      text:"No tenÃ©s permiso para ingresar",
      confirmButtonText:"Aceptar"
    }).then(()=>{
      window.location.href="/Horarios/Login/Login.html";
    });
    return;
  }

})();
</script>

</body>
</html>
