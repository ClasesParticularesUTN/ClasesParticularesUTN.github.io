<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Visor de Cap√≠tulos PDF</title>

<!-- ‚úÖ SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- ‚úÖ PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
</script>

<style>
  body {
    margin: 0;
    display: flex;
    height: 100vh;
    font-family: Arial, Helvetica, sans-serif;
    background: #f5f5f5;
    overflow: hidden;
  }

  /* MEN√ö IZQ */
  #menu {
    width: 300px;
    background: #111;
    color: #fff;
    padding: 15px;
    overflow-y: auto;
    box-sizing: border-box;
    transition: transform 0.3s, width 0.3s, padding 0.3s;
  }
  #menu.oculto {
    width: 0;
    padding: 0;
    transform: translateX(-300px);
  }
  #menu h2{
    text-align:center;
  }
  .item-pdf {
    background: #222;
    margin-bottom: 10px;
    padding: 14px;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: .25s;
    border:1px solid #333;
  }
  .item-pdf:hover {
    background:#333;
    transform:scale(1.03);
  }

  /* AREA PDF */
  #visorArea {
    flex:1;
    position:relative;
    display:flex;
    flex-direction:column;
    background:#f5f5f5;
  }
  #visor {
    flex:1;
    overflow-y:auto;
    padding:10px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
  }
  canvas {
    border:1px solid #aaa;
    background:white;
    max-width:100%;
  }
  #toggleMenuBtn {
    position:absolute;
    top:15px;
    left:15px;
    background:#222;
    color:#fff;
    border:none;
    font-size:14px;
    border-radius:5px;
    padding:7px 10px;
    cursor:pointer;
    z-index:20;
  }
  #placeholder{
    color:#555;
    font-size:20px;
    margin-top:50px;
  }
</style>

</head>
<body>

<div id="menu">
  <h2>Cap√≠tulos</h2>
  <div id="lista"></div>
</div>

<div id="visorArea">
  <button id="toggleMenuBtn">‚ò∞ Men√∫</button>
  <div id="visor">
    <div id="placeholder">üìÑ Seleccion√° un cap√≠tulo</div>
  </div>
</div>

<script>
/* ===========================
      LISTA DE PDFs
=========================== */
const pdfs = [
  "Capitlo 1.pdf",
  "Capitulo 2.pdf",
  "Capitulo 3.pdf",
  "Estructuras De Seleccion.pdf",
  "Estructuras de repeticion.pdf",
  "Funciones.pdf",
  "Arreglos.pdf",
  "Strings.pdf",
  "Structs.pdf",
  "Punteros.pdf",
  "Archivos.pdf",
];

const menu = document.getElementById("menu");
const lista = document.getElementById("lista");
const visor = document.getElementById("visor");

let currentTask = null;
let currentPdf  = null;

/* construir men√∫ */
pdfs.forEach(nombre => {
  const d = document.createElement("div");
  d.className = "item-pdf";
  d.textContent = nombre.replace(/\.pdf$/,"");
  d.onclick = ()=>abrirPDF(nombre);
  lista.appendChild(d);
});

async function limpiarPDF(){
  try{ if(currentTask) await currentTask.destroy(); }catch{}
  try{ if(currentPdf) await currentPdf.destroy(); }catch{}
  currentTask=null;
  currentPdf=null;
  visor.innerHTML="";
}

function ocultarMenu(){ menu.classList.add("oculto"); }
function mostrarMenu(){ menu.classList.remove("oculto"); }

document.getElementById("toggleMenuBtn").onclick = ()=>{
  if(menu.classList.contains("oculto")) mostrarMenu();
  else ocultarMenu();
};

async function abrirPDF(nombre){
  ocultarMenu();
  await limpiarPDF();

  visor.innerHTML = `<div id="placeholder">Cargando...</div>`;

  const url = `Capitulo/${nombre}`;
  const loadingTask = pdfjsLib.getDocument({
    url,
    disableAutoFetch:true,
    disableStream:true
  });
  currentTask = loadingTask;

  const pdf = await loadingTask.promise;
  currentPdf = pdf;

  visor.innerHTML = "";
  renderAll(pdf);
}

async function renderAll(pdf){
  const total = pdf.numPages;
  const scale = 1.35;
  for(let i=1;i<=total;i++){
    if(currentPdf!==pdf) return;
    const page = await pdf.getPage(i);
    const vp = page.getViewport({scale});
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width  = vp.width;
    canvas.height = vp.height;
    visor.appendChild(canvas);
    await page.render({canvasContext:ctx, viewport:vp}).promise;
  }
}
</script>


<!-- ‚úÖ VALIDAR USUARIO (AHORA AL FINAL = OK) -->
<script>
(function validarAcceso(){

  const alumnoStr = sessionStorage.getItem("persona");

  // No existe ‚Üí login
  if(!alumnoStr){
    window.location.href="/Horarios/Login/Login.html";
    return;
  }

  const alumno = JSON.parse(alumnoStr);

  const correosPermitidos=[
    "valedasilvacatela.vdc@gmail.com",
    "solmaina@gmail.com",
    "pazantivero01@gmail.com",
    "renzomercanti2005@gmail.com"
  ];

  const permitido = correosPermitidos.includes(
    (alumno.correoElectronico||"").toLowerCase()
  );

  if(!permitido){

    Swal.fire({
      icon:"error",
      title:"Acceso denegado",
      text:"No ten√©s permiso para ingresar",
      confirmButtonText:"Aceptar"
    }).then(()=>{
      window.location.href="/Horarios/Login/Login.html";
    });

    return;
  }

  console.log("‚úÖ Acceso permitido:", alumno.correoElectronico);

})();
</script>

</body>
</html>
