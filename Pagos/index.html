<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Clases Particulares UTN</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            /* Variables comunes */
            --primary: #f3a661; 
            --primary-dark: #d48b45;
            --warning: #e67e22;
            
            /* Modo Oscuro (Por defecto) */
            --bg: #1a1a24;
            --header-bg: rgba(37, 37, 51, 0.95);
            --card-bg: #252533;
            --text-main: #e2e2e8;
            --text-muted: #b0b0b8;
            --glass-border: rgba(243, 166, 97, 0.25);
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
            --footer-bg: rgba(37, 37, 51, 0.98);
        }

        /* Variables Modo Claro */
        body.light-mode {
            --bg: #f0f4f8;
            --header-bg: rgba(255, 255, 255, 0.95);
            --card-bg: #ffffff;
            --text-main: #1a1a24;
            --text-muted: #64748b;
            --glass-border: rgba(243, 166, 97, 0.4);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --footer-bg: rgba(255, 255, 255, 0.98);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background-color: var(--bg); 
            color: var(--text-main); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        header {
            background: var(--header-bg);
            backdrop-filter: blur(15px);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        header h1 { font-size: 1.5rem; font-weight: 700; flex-grow: 1; }

        /* Bot√≥n Modo Claro/Oscuro */
        .theme-toggle {
            background: rgba(243, 166, 97, 0.1);
            border: 1px solid var(--glass-border);
            color: var(--primary);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: 0.3s;
        }

        /* --- LOADERS --- */
        .loader {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: var(--bg);
            display:flex; justify-content:center; align-items:center;
            z-index:9999; flex-direction: column; gap:20px;
            text-align: center; padding: 20px;
        }
        .loader.hidden { display:none; }

        .spinner {
            border: 4px solid rgba(243, 166, 97, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%; width:50px; height:50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .progress-container {
            width: 80%; max-width: 300px; height: 6px;
            background: rgba(128,128,128,0.2); border-radius: 10px; overflow: hidden;
        }
        .progress-bar {
            width: 0%; height: 100%; background: var(--primary);
            animation: progress 45s linear forwards;
        }
        @keyframes progress { 0% { width: 0%; } 100% { width: 95%; } }

        /* --- CONTENEDOR --- */
        .container { max-width: 600px; margin: 0 auto; padding: 0 15px 140px; }

        .empty-state {
            text-align: center; padding: 60px 20px;
            background: var(--card-bg); border-radius: 25px;
            border: 1px solid var(--glass-border); margin-top: 20px;
            box-shadow: var(--shadow);
        }
        .empty-state .icon { font-size: 50px; margin-bottom: 15px; display: block; }

        .card {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card-bg); border-radius: 18px; padding: 18px;
            border: 1px solid var(--glass-border); margin-bottom: 12px;
            margin-top: 15px;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }

        .info strong { font-size: 1.1rem; color: var(--primary); display: block; }
        .info .details { font-size: 0.85rem; color: var(--text-muted); display: block; }

        .controles { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
        
        .pago-checkbox {
            display: flex; align-items: center; gap: 8px;
            font-size: 0.85rem; font-weight: 700; color: var(--text-main);
            cursor: pointer; background: rgba(128,128,128,0.1);
            padding: 8px 16px; border-radius: 12px; transition: 0.2s;
        }
        .pago-checkbox:has(input:checked) { background: var(--primary); color: #1a1a24; }

        .price-display { font-size: 1.2rem; font-weight: 800; color: var(--text-main); }
        .old-price { font-size: 0.85rem; color: var(--text-muted); text-decoration: line-through; margin-right: 5px; font-weight: 400; }
        .recargo-tag { font-size: 0.7rem; color: var(--warning); font-weight: bold; display: block; }

        /* --- FOOTER --- */
        .footer-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--footer-bg); padding: 15px 0 35px;
            backdrop-filter: blur(20px);
            box-shadow: 0 -10px 25px rgba(0,0,0,0.15);
            display: none; z-index: 1000;
            border-top-left-radius: 25px; border-top-right-radius: 25px;
            border-top: 1px solid var(--glass-border);
        }
        .footer-content {
            max-width: 600px; margin: 0 auto; padding: 0 25px;
            display: flex; justify-content: space-between; align-items: center;
        }

        button.btn-pago {
            background: var(--primary); color: #1a1a24; border: none;
            border-radius: 16px; padding: 14px 28px; font-size: 1rem;
            font-weight: 700; cursor: pointer; transition: 0.3s;
        }
        button.btn-pago:hover { transform: scale(1.05); }

        @media (max-width: 450px) {
            .card { flex-direction: column; align-items: flex-start; }
            .controles { width: 100%; flex-direction: row; justify-content: space-between; margin-top: 12px; border-top: 1px solid var(--glass-border); padding-top: 12px; }
        }
    </style>
</head>
<body>

<header>
    <div style="width: 40px;"></div> <h1>Registro de pagos</h1>
    <button class="theme-toggle" onclick="toggleTheme()" title="Cambiar modo">
        <i id="theme-icon" class="fas fa-sun"></i>
    </button>
</header>

<div class="container">
    <div id="loaderClases" class="loader">
        <div class="spinner"></div>
        <p>Buscando clases pendientes...</p>
    </div>

    <div id="loaderPago" class="loader hidden">
        <div class="spinner"></div>
        <div style="font-weight: 800; font-size: 1.1rem;">Iniciando servidor de pagos</div>
        <div class="progress-container"><div class="progress-bar"></div></div>
        <p style="color: var(--warning); font-size: 0.9rem; max-width: 250px; margin: 0 auto;">El servidor puede tardar hasta 1 minuto en responder. Por favor espera.</p>
    </div>

    <div class="productos" id="productos"></div>
</div>

<div class="footer-bar" id="totalContainer">
    <div class="footer-content">
        <div class="total-text">
            <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600;">TOTAL</div>
            <div style="font-size: 1.5rem; font-weight: 900;">$<span id="total">0</span></div>
        </div>
        <button class="btn-pago" onclick="pagarSeleccion()">Ir a Mercado Pago</button>
    </div>
</div>

<script>
// L√≥gica de Temas (Oscuro por defecto)
window.addEventListener("load", () => {
  fetch("https://mercadopago-di7q.onrender.com/ping").catch(() => {});
  alert("Servidor de pagos iniciado.");
});

function toggleTheme() {
    const body = document.body;
    const icon = document.getElementById('theme-icon');
    
    body.classList.toggle('light-mode');
    
    if(body.classList.contains('light-mode')) {
        icon.classList.replace('fa-sun', 'fa-moon');
    } else {
        icon.classList.replace('fa-moon', 'fa-sun');
    }
}

// --- LOGICA ORIGINAL ---
const sessionData = sessionStorage.getItem("persona");
let Alumno = sessionData ? JSON.parse(sessionData) : null;

if (!Alumno || !Alumno.correoElectronico) {
    window.location.href = "/Horarios/Login/Login.html";
}

const correoAlumno = Alumno.correoElectronico;
const GAS_URL = "https://script.google.com/macros/s/AKfycbwvSTFpClvlYupAvfgpR7YTvd90x7AN0t4EJZ5x7xarJ-ga1wRtWxNTDDy-Wm4judEX/exec";
const BACKEND_URL = "https://mercadopago-di7q.onrender.com/crear-preferencia";

let clases = [];

async function cargarClases() {
    try {
        document.getElementById("loaderClases").classList.remove("hidden");
        const res = await fetch(`${GAS_URL}?funcion=devolverDeuda&correo=${encodeURIComponent(correoAlumno)}`);
        const data = await res.json();

        clases = data.map((c, index) => {
            const precioBase = parseFloat(c.precio) || 0;
            const recargoValor = parseFloat(c.recargo) || 0;
            const recargoFinal = (Alumno.condicionPago === 'Libre') ? 0 : recargoValor;
            
            return {
                id: index,
                fecha: c.fecha,
                modalidad: c.modalidad,
                horas: c.horas,
                precioOriginal: precioBase,
                recargoAplicado: recargoFinal,
                precioEditado: precioBase + recargoFinal,
                codigo: c.codigo 
            };
        });

        mostrarClases();
    } catch(e) {
        alert("Error al cargar deuda.");
    } finally {
        document.getElementById("loaderClases").classList.add("hidden");
    }
}

function mostrarClases() {
    const contenedor = document.getElementById("productos");
    contenedor.innerHTML = "";

    if (clases.length === 0) {
        contenedor.innerHTML = `
            <div class="empty-state">
                <span class="icon">‚ú®</span>
                <h2>¬°Est√°s al d√≠a!</h2>
                <p>No tienes clases pendientes de pago.</p>
            </div>`;
        return;
    }

    clases.forEach(c => {
        const card = document.createElement("div");
        card.className = "card";
        
        const tieneRecargo = c.recargoAplicado > 0;
        const htmlPrecio = tieneRecargo 
            ? `<span class="old-price">$${c.precioOriginal.toLocaleString('es-AR')}</span>
               <span class="price-display">$${c.precioEditado.toLocaleString('es-AR')}</span>
               <span class="recargo-tag">Incluye recargo</span>`
            : `<span class="price-display">$${c.precioEditado.toLocaleString('es-AR')}</span>`;

        card.innerHTML = `
            <div class="info">
                <strong>${c.modalidad}</strong>
                <span class="details">üìÖ ${c.fecha} | ‚è±Ô∏è ${c.horas} hs</span>
            </div>
            <div class="controles">
                <div style="text-align:right">
                    ${htmlPrecio}
                </div>
                <label class="pago-checkbox">
                    <input type="checkbox" value="${c.id}" onchange="actualizarTotal()">
                    Pagar
                </label>
            </div>`;
        contenedor.appendChild(card);
    });
    actualizarTotal();
}

function actualizarTotal() {
    let total = 0;
    let haySeleccion = false;
    clases.forEach(c => {
        const cb = document.querySelector(`input[type="checkbox"][value="${c.id}"]`);
        if (cb && cb.checked) { 
            total += c.precioEditado; 
            haySeleccion = true; 
        }
    });
    document.getElementById("totalContainer").style.display = haySeleccion ? "block" : "none";
    document.getElementById("total").textContent = total.toLocaleString('es-AR');
}

async function pagarSeleccion() {
    const items = [];
    clases.forEach(c => {
        const cb = document.querySelector(`input[type="checkbox"][value="${c.id}"]`);
        if (cb && cb.checked) {
            items.push({ 
                title: `${c.modalidad} (${c.fecha})`, 
                price: c.precioEditado, 
                codigo: c.codigo 
            });
        }
    });

    try {
        if (items.length === 0) {
          alert("Seleccion√° al menos una clase");
          return;
        }

        document.getElementById("loaderPago").classList.remove("hidden");
        const res = await fetch(BACKEND_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ items, email: correoAlumno })
        });
        const data = await res.json();
        
        if (data.init_point) {
            window.location.href = data.init_point;
        } else {
            throw new Error();
        }
    } catch(e) {
        alert("El servidor de pagos est√° demorando. Reintenta en un momento.");
        document.getElementById("loaderPago").classList.add("hidden");
    }
}

cargarClases();
</script>
</body>
</html>
