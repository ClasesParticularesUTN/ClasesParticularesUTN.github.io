<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ficha del Alumno</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Loader Spinner */
    #loaderSpinner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255,255,255,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      transition: opacity 0.3s;
    }
    .lds-dual-ring {
      display: inline-block;
      width: 80px;
      height: 80px;
    }
    .lds-dual-ring:after {
      content: " ";
      display: block;
      width: 64px;
      height: 64px;
      margin: 8px;
      border-radius: 50%;
      border: 6px solid #0077cc;
      border-color: #0077cc transparent #0077cc transparent;
      animation: lds-dual-ring 1.2s linear infinite;
    }
    @keyframes lds-dual-ring {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }
    main {
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);

      width: 100%;
      padding: 30px 40px;
    }
    h1 {
      font-weight: 700;
      font-size: 2.2rem;
      margin-bottom: 20px;
      color: #222;
      border-bottom: 3px solid #0077cc;
      padding-bottom: 8px;
    }
    #error {
      color: #d9534f;
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
      display: none;
    }
    .info-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 35px;
    }
    .card {
      flex: 1 1 45%;
      background: #f9fafb;
      border-radius: 10px;
      padding: 18px 22px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      display: flex;
      align-items: center;
      gap: 15px;
      min-width: 250px;
    }
    .card .icon {
      font-size: 1.8rem;
      color: #0077cc;
      width: 30px;
      text-align: center;
    }
    .card .label {
      font-weight: 600;
      color: #555;
      flex: 0 0 130px;
      user-select: none;
    }
    .card .value {
      font-weight: 500;
      color: #111;
      flex: 1;
      word-break: break-word;
    }
    h2 {
      font-weight: 700;
      font-size: 1.8rem;
      margin-bottom: 15px;
      color: #222;
      border-bottom: 2px solid #0077cc;
      padding-bottom: 6px;
    }
    table.reservas {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 10px;
      font-size: 0.95rem;
      color: #333;
    }
    table.reservas thead tr {
      background-color: #0077cc;
      color: white;
      border-radius: 8px;
      user-select: none;
    }
    table.reservas th, table.reservas td {
      padding: 12px 15px;
      text-align: left;
    }
    table.reservas tbody tr {
      background: white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }
    table.reservas tbody tr:hover {
      background-color: #e6f0fb;
    }
    table.reservas tbody tr td {
      border: none;
    }
    .verMas{
        display: none;
        
    }
    /* Responsive */
    @media (max-width: 520px) {
      .info-cards {
        flex-direction: column;
      }
      .card {
        flex: 1 1 100%;
      }
      table.reservas th, table.reservas td {
        padding: 10px 8px;
      }
      .ocultar{
        display: none;
      }
      .verMas{
        display: block;
        color: #0077cc;
        text-decoration: underline;
        cursor: pointer;
      }
      .value{
        font-size: 80%;
      }
      .listadoreservas{
        font-size:80%;
        text-align:center;
      }
      td{
        text-align: center;
      }
    }
    
  </style>
  <style>
    /* Estilos para los botones grandes iniciales */
    .large-filtro-container{
      display:flex;
      gap:12px;
      width:100%;
    }
    .large-filtro-btn{
      flex:1 1 0;
      padding:18px 12px;
      border-radius:10px;
      border:2px solid rgba(0,119,204,0.12);
      background: linear-gradient(180deg,#fbfdff 0%, #ffffff 100%);
      color:#004a8a;
      font-weight:700;
      font-size:1.05rem;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, color .12s ease, box-shadow .12s ease;
      box-shadow: 0 6px 18px rgba(3,55,102,0.04);
    }
    .large-filtro-btn:hover{ transform: translateY(-3px); }
    .large-filtro-btn.active{ background:#0077cc; color:#fff; }

    .large-filtro-title{
      font-size:1.05rem;
      color:#223;
      font-weight:700;
      margin-bottom:8px;
      text-align:left;
    }

    /* Estilos para los botones peque√±os (barra superior) */
    .filtro-btn{
      padding:6px 12px;
      border-radius:8px;
      border:1px solid #b9d8f6;
      background:transparent;
      color:#0077cc;
      cursor:pointer;
      font-weight:600;
    }
    .filtro-btn.active{
      background:#0077cc;
      color:#fff;
      box-shadow:0 6px 18px rgba(0,119,204,0.12);
    }

    @media (max-width:520px){
      .large-filtro-btn{ padding:12px 8px; font-size:0.95rem; }
      .large-filtro-container{ flex-direction:column; }
    }
  </style>
</head>
<body>
  <div id="loaderSpinner"><div class="lds-dual-ring"></div></div>
  <main style="display:none;">
    <h1>Ficha del Alumno</h1>
    <div id="error"></div>

    <section class="info-cards">
      <div class="card"><div class="icon">üë§</div><div class="label">Nombre</div><div class="value ocultar" id="nombre"></div><div class="verMas" data-target="nombre">Ver m√°s</div></div>
      <div class="card"><div class="icon">üë•</div><div class="label">Apellido</div><div class="value ocultar" id="apellido"></div><div class="verMas" data-target="apellido">Ver m√°s</div></div>
      <div class="card"><div class="icon">‚úâÔ∏è</div><div class="label">Correo electr√≥nico</div><div class="value ocultar" id="correoElectronico"></div><div class="verMas" data-target="correoElectronico">Ver m√°s</div></div>
      <div class="card"><div class="icon">üìû</div><div class="label">Tel√©fono</div><div class="value ocultar" id="telefono"></div><div class="verMas" data-target="telefono">Ver m√°s</div></div>
      <div class="card"><div class="icon">üìÖ</div><div class="label">A√±o Ingreso</div><div class="value ocultar" id="anioIngreso"></div><div class="verMas" data-target="anioIngreso">Ver m√°s</div></div>
      <div class="card"><div class="icon">üìö</div><div class="label">Materia</div><div class="value ocultar" id="materia"></div><div class="verMas" data-target="materia">Ver m√°s</div></div>
      <div class="card"><div class="icon">üìù</div><div class="label">Estado en la materia</div><div class="value ocultar" id="estadoEnLaMateria"></div><div class="verMas" data-target="estadoEnLaMateria">Ver m√°s</div></div>
      <div class="card"><div class="icon">üí¨</div><div class="label">Comentario</div><div class="value ocultar" id="comentario"></div><div class="verMas" data-target="comentario">Ver m√°s</div></div>
      <div class="card"><div class="icon">‚è∞</div><div class="label">Horas a favor</div><div class="value" id="horasAFavor"></div></div>
      <div class="card"><div class="icon">üí≥</div><div class="label">Fecha de pago</div><div class="value" id="fechaDePago"></div></div>
  <div class="card"><div class="icon">üí∞</div><div class="label">Dinero que debe</div><div class="value" id="dineroQueDebe"></div></div>
  <div class="card" id="cardDineroTotal" style="display:none;"><div class="icon">üíµ</div><div class="label">Dinero total</div><div class="value" id="dineroTotal"></div></div>
  <div class="card"><div class="icon">üéÅ</div><div class="label">Pack</div><div class="value" id="pack"></div></div>
    </section>

    <!-- Modal para mostrar info en m√≥vil -->
    <div id="modalInfo" style="display:none; position:fixed; z-index:3000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); align-items:center; justify-content:center;">
      <div style="background:white; border-radius:12px; max-width:90vw; padding:48px 20px 28px 20px; box-shadow:0 4px 24px rgba(0,0,0,0.18); text-align:center; position:relative;">
        <button id="cerrarModalInfo" style="position:absolute; top:8px; right:12px; background:none; border:none; font-size:1.7rem; cursor:pointer; color:#0077cc;">&times;</button>
        <div id="modalInfoLabel" style="font-weight:600; color:#0077cc; font-size:1.1rem; margin-bottom:10px;"></div>
        <div id="modalInfoValue" style="font-size:1.1rem; color:#222;"></div>
      </div>
    </div>

    <!-- Contenedor inicial con 3 botones grandes que ocupan todo el ancho -->
    <div id="largeFiltroContainer" style="margin-bottom:12px;">
      <div class="large-filtro-title">Elige qu√© tipo de horarios quieres filtrar</div>
      <div class="large-filtro-container">
        <button class="large-filtro-btn" data-filter="Debe">Debe</button>
        <button class="large-filtro-btn" data-filter="Pago">Pago</button>
        <button class="large-filtro-btn" data-filter="Pack">Pack</button>
      </div>
    </div>

    <div style="display:flex; align-items:center; gap:12px; justify-content:space-between; flex-wrap:wrap; margin-bottom:6px;">
      <h2 id="reservasTitle" style="display:none;">Horarios Adeudados o Futuros</h2>
      <div id="filtroReservas" style="display:none; gap:8px; align-items:center;">
        <span style="font-weight:600; margin-right:6px; color:#555;">Filtrar:</span>
        <button class="filtro-btn" data-filter="Debe">Debe</button>
        <button class="filtro-btn" data-filter="Pago">Pago</button>
        <button class="filtro-btn" data-filter="Pack">Pack</button>
      </div>
    </div>

    <table class="reservas" aria-label="Tabla de horarios reservados" style="display:none;">
      <thead>
        <tr>
          <th style="text-align:center;">Fecha Reservado</th>
          <th style="text-align:center;">Estado</th>
          <th style="text-align:center;">Cant. Horas</th>
        </tr>
      </thead>
      <tbody id="reservasBody">
        <!-- Se llenar√° con JavaScript -->
      </tbody>
    </table>
    
  </main>
<div id="scrollToBottomBtn" 
     style="position: fixed; bottom: 24px; right: 24px; font-size: 3rem; z-index: 1000; border-radius: 50%; padding: 10px 14px; cursor: pointer; transform: rotate(270deg); user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; touch-action: manipulation;" 
     tabindex="0" aria-label="Ir al final" role="button"
     oncontextmenu="return false;"
     draggable="false"
     >üîö</div>
<script src="../Horarios/JS/URLS.js"></script>
<script>
    // Bot√≥n para ir al final de la p√°gina
    const scrollBtn = document.getElementById("scrollToBottomBtn");
    scrollBtn.onclick = function(e) {
        e.preventDefault();
        window.scrollTo({ top: document.body.scrollHeight });
    };
    // Prevenir selecci√≥n y acciones contextuales en m√≥viles
    scrollBtn.addEventListener('mousedown', e => e.preventDefault());
    scrollBtn.addEventListener('selectstart', e => e.preventDefault());
    scrollBtn.addEventListener('dragstart', e => e.preventDefault());
    scrollBtn.addEventListener('contextmenu', e => e.preventDefault());

    // Modal para mostrar info de la card en m√≥vil
    const modal = document.getElementById('modalInfo');
    const modalLabel = document.getElementById('modalInfoLabel');
    const modalValue = document.getElementById('modalInfoValue');
    const cerrarModal = document.getElementById('cerrarModalInfo');
    cerrarModal.onclick = () => { modal.style.display = 'none'; };
    // Cerrar modal al tocar fuera del contenido
    modal.addEventListener('click', function(e) {
      if (e.target === modal) modal.style.display = 'none';
    });
    // Asignar eventos a los botones "Ver m√°s"
    document.querySelectorAll('.verMas').forEach(btn => {
      btn.onclick = function() {
        const targetId = btn.getAttribute('data-target');
        const label = btn.parentElement.querySelector('.label').textContent;
        const value = document.getElementById(targetId).textContent;
        modalLabel.textContent = label;
        modalValue.textContent = value;
        modal.style.display = 'flex';
      };
    });

    // Mostrar loader y ocultar main al inicio
    const loader = document.getElementById("loaderSpinner");
    const main = document.querySelector("main");
    loader.style.display = "flex";
    main.style.display = "none";

    // Obtener par√°metros de la URL
    const params = new URLSearchParams(window.location.search);
    let nombre = params.get("nombre");
    let apellido = params.get("apellido");
    const personaSession = sessionStorage.getItem("persona");
    console.log(personaSession)
    if (!nombre) {
      console.log("No hay nombre");
      if (personaSession) {
        try {
          const personaObj = JSON.parse(personaSession);
          if (personaObj && personaObj.nombre) {
            nombre = personaObj.nombre;
          }
        } catch (e) {
          console.warn("No se pudo parsear persona de sessionStorage");
        }
      }else{
          window.localtion = '/Horarios/Login/Login.html';
      }
    }
    if (!apellido) {
      if (personaSession) {
        try {
          const personaObj = JSON.parse(personaSession);
          if (personaObj && personaObj.apellido) {
            apellido = personaObj.apellido;
          }
        } catch (e) {
          console.warn("No se pudo parsear persona de sessionStorage");
        }
      }else{
          window.location = '/Horarios/Login/Login.html';
      }
    }

    const url = URLUsuarios +
                            `?funcion=devolverFicha&nombre=${encodeURIComponent(nombre)}&apellido=${encodeURIComponent(apellido)}`;
    console.log(url)
    let Alumno;
    fetch(url)
        .then(res => res.json())
        .then(data => {
            console.log(data);
            const errorDiv = document.getElementById("error");
            if (data.error) {
                errorDiv.textContent = data.error;
                errorDiv.style.display = "block";
                loader.style.display = "none";
                main.style.display = "block";
                return;
            }
            errorDiv.style.display = "none";
            // Datos personales
            data.abrirLink = function () {
              window.open(this.linkHoja, "_blank");
            };
            Alumno = data;
            document.getElementById("nombre").textContent = data.nombre || "";
            document.getElementById("apellido").textContent = data.apellido || "";
            document.getElementById("correoElectronico").textContent = data.correoElectronico || "";
            document.getElementById("telefono").textContent = data.telefono || "";
            document.getElementById("anioIngreso").textContent = data.anoIngreso || "";
            document.getElementById("materia").textContent = data.materia || "";
            document.getElementById("estadoEnLaMateria").textContent = data.estadoEnLaMateriaa || "";
            document.getElementById("comentario").textContent = data.comentario || "";
            document.getElementById("horasAFavor").textContent = data.horasAFavor || "Sin horas a favor";
            document.getElementById("fechaDePago").textContent = data.fechaDePago || "No pag√≥ pack";

      document.getElementById("dineroQueDebe").textContent = data.dineroQueDebe || "0";
      document.getElementById("pack").textContent = data.pack || "No pag√≥ pack";
      // Dinero total solo si existe
      if (typeof data.dineroTotal !== 'undefined' && data.dineroTotal !== null) {
        const dineroTotalElem = document.getElementById("dineroTotal");
        dineroTotalElem.textContent = "$" + data.dineroTotal;
        dineroTotalElem.style.color = "#2e7d32";
        document.getElementById("cardDineroTotal").style.display = "flex";
      } else {
        document.getElementById("cardDineroTotal").style.display = "none";
      }

            if(parseInt(document.getElementById("dineroQueDebe").textContent) > 0) {
                document.getElementById("dineroQueDebe").style.color = "red";
                document.getElementById("dineroQueDebe").textContent = "$"+document.getElementById("dineroQueDebe").textContent;
                Swal.fire({
                    icon: 'warning',
                    title: '¬°Atenci√≥n!',
                    text: 'Recuerde que debe dinero.',
                    confirmButtonText: 'Entendido'
                });
            }
            // Reservas - ahora renderizamos seg√∫n filtro seleccionado
            const tbody = document.getElementById("reservasBody");
            tbody.innerHTML = ""; // limpiar por si hab√≠a algo antes

            // Control de filtro: valores posibles: 'Pago', 'Debe', 'Pack'
            let currentFilter = null; // inicialmente nada seleccionado

            const filtros = document.querySelectorAll('.filtro-btn');
            const largeFiltros = document.querySelectorAll('.large-filtro-btn');

            // Funci√≥n auxiliar para marcar active en ambos sets
            function markActive(filter){
              filtros.forEach(x => { if (x.dataset.filter === filter) x.classList.add('active'); else x.classList.remove('active'); });
              largeFiltros.forEach(x => { if (x.dataset.filter === filter) x.classList.add('active'); else x.classList.remove('active'); });
            }

            filtros.forEach(b => {
              b.addEventListener('click', () => {
                // Si no hay selecci√≥n previa (p. ej. user us√≥ botones peque√±os), mostramos la UI completa
                if (!currentFilter) {
                  showTablaYBarra();
                }
                currentFilter = b.dataset.filter;
                markActive(currentFilter);
                document.getElementById('reservasTitle').textContent = `Horarios - ${currentFilter}`;
                renderReservas();
              });
            });

            largeFiltros.forEach(b => {
              b.addEventListener('click', () => {
                // Ocultar el contenedor grande y mostrar la tabla + barra peque√±a
                currentFilter = b.dataset.filter;
                markActive(currentFilter);
                showTablaYBarra();
                document.getElementById('reservasTitle').textContent = `Horarios - ${currentFilter}`;
                renderReservas();
              });
            });

            function renderReservas(){
              tbody.innerHTML = '';
              (Alumno.reservas || []).forEach(r => {
                const estadoRaw = (r.estado || '').toLowerCase();
                let categoria = 'Pago';
                if (estadoRaw.includes('debe')) categoria = 'Debe';
                else if (estadoRaw.includes('pack')) categoria = 'Pack';
                else if (estadoRaw.includes('pago') || estadoRaw.includes('pag')) categoria = 'Pago';

                if (categoria !== currentFilter) return; // no coincide con el filtro

                const fila = document.createElement('tr');
                fila.innerHTML = `
                  <td style="font-size:80%;text-align:center">${r.fechaReservado}</td>
                  <td style="font-size:80%;text-align:center">${r.estado}</td>
                  <td style="text-align:center">${r.cantHoras}</td>
                `;
                tbody.appendChild(fila);

                // Aplicar estilo al <td> de estado (segunda celda)
                if (r.estado && typeof r.estado === 'string') {
                  const estadoTd = fila.children[1];
                  if (estadoRaw.includes('debe')) {
                    estadoTd.style.backgroundColor = '#ffd6d6';
                    estadoTd.style.color = '#000';
                  } else if (estadoRaw.includes('pago') || estadoRaw.includes('pag')) {
                    estadoTd.style.backgroundColor = '#2e7d32';
                    estadoTd.style.color = '#fff';
                  } else if (estadoRaw.includes('pack')) {
                    estadoTd.style.backgroundColor = '#d0f5e8';
                    estadoTd.style.color = '#000';
                  }
                  if (r.estado === 'Ext. Pack') {
                    estadoTd.style.backgroundColor = '#ffb74d';
                  }
                  estadoTd.style.borderRadius = '10%';
                }
              });
            }

            function showTablaYBarra(){
              // ocultar botones grandes
              const largeContainer = document.getElementById('largeFiltroContainer');
              if (largeContainer) largeContainer.style.display = 'none';
              // mostrar titulo, barra peque√±a y tabla
              const title = document.getElementById('reservasTitle');
              const tabla = document.querySelector('table.reservas');
              const barra = document.getElementById('filtroReservas');
              if (title) title.style.display = 'block';
              if (barra) barra.style.display = 'flex';
              if (tabla) tabla.style.display = 'table';
            }

            // No mostrar nada hasta que el usuario elija: currentFilter === null
            // Si quieres seleccionar por defecto, cambiar currentFilter y llamar a showTablaYBarra() y renderReservas().
            // Ocultar loader y mostrar main
            loader.style.display = "none";
            main.style.display = "block";
        })
        .catch(err => {
            console.error("Error al cargar los datos:", err);
            const errorDiv = document.getElementById("error");
            errorDiv.textContent = "Ocurri√≥ un error al obtener los datos.";
            errorDiv.style.display = "block";
            loader.style.display = "none";
            main.style.display = "block";
        });
        document.addEventListener('keydown', function(e) {
          if (!e.altKey) return;
          const key = e.key ? e.key.toLowerCase() : String.fromCharCode(e.keyCode).toLowerCase();
          if (key !== 'a') return;
          const tgt = e.target;
          if (tgt && (tgt.tagName === 'INPUT' || tgt.tagName === 'TEXTAREA' || tgt.isContentEditable)) return;
          e.preventDefault();
          if (typeof Alumno === 'object' && Alumno && typeof Alumno.abrirLink === 'function') {
            try {
              Alumno.abrirLink();
            } catch (err) {
              console.error(err);
              Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo abrir el enlace.' });
            }
          } else {
            Swal.fire({ icon: 'info', title: 'Informaci√≥n', text: 'No hay alumno cargado o falta Alumno.abrirLink().' });
          }
        });

</script>
</body>
</html>
