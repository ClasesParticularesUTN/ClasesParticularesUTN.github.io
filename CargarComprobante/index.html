<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Clases Particulares UTN</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root {
            --primary: #0077c2;
            --primary-dark: #005ea3;
            --accent: #00b894;
            --warning: #e67e22;
            --bg: #f0f4f8;
            --text-main: #1a1a1a;
            --text-light: #64748b;
            --white: #ffffff;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body, html { 
            margin:0; padding:0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
        }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; padding: 30px 20px; text-align: center;
            border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
            box-shadow: var(--shadow); margin-bottom: 20px;
        }

        h1 { margin:0; font-size: 1.5rem; font-weight: 800; }

        /* Loaders */
        .loader {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(255, 255, 255, 0.95);
            display:flex; justify-content:center; align-items:center;
            z-index:9999; flex-direction: column; gap:20px;
            backdrop-filter: blur(10px); text-align: center; padding: 20px; box-sizing: border-box;
        }
        .loader.hidden { display:none; }

        .spinner {
            border: 4px solid rgba(0, 119, 194, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%; width:50px; height:50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Barra de progreso para el loader de pago */
        .progress-container {
            width: 80%; max-width: 300px; height: 6px;
            background: #eee; border-radius: 10px; overflow: hidden; margin-top: 10px;
        }
        .progress-bar {
            width: 0%; height: 100%; background: var(--primary);
            animation: progress 45s linear forwards; /* Simula la espera del server */
        }
        @keyframes progress { 0% { width: 0%; } 100% { width: 95%; } }

        .warning-text {
            color: var(--warning); font-size: 0.9rem; font-weight: 600;
            max-width: 280px; margin-top: 5px;
        }

        /* Layout Cards */
        .container { max-width: 600px; margin: 0 auto; padding: 0 15px 140px; }
        .productos { display: grid; gap: 12px; }

        .card {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--white); border-radius: 18px; padding: 18px;
            border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: var(--shadow);
        }

        .info { display: flex; flex-direction: column; gap: 2px; }
        .info strong { font-size: 1.1rem; color: var(--primary); }
        .info .details { font-size: 0.85rem; color: var(--text-light); }
        
        .recargo-tag {
            font-size: 0.75rem; background: #fff3e0; color: var(--warning);
            padding: 2px 8px; border-radius: 6px; font-weight: 700;
            display: inline-block; margin-top: 4px;
        }

        .controles { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }

        .pago-checkbox {
            display: flex; align-items: center; gap: 8px;
            font-size: 0.85rem; font-weight: 700; color: var(--text-light);
            cursor: pointer; background: #edf2f7;
            padding: 8px 16px; border-radius: 12px; transition: 0.2s;
        }
        .pago-checkbox:has(input:checked) { background: var(--accent); color: white; }

        .price-display { font-size: 1.2rem; font-weight: 800; }
        .sub-price { font-size: 0.75rem; color: var(--text-light); text-decoration: line-through; }

        /* Barra Inferior */
        .footer-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--white); padding: 15px 0 30px;
            box-shadow: 0 -10px 25px rgba(0,0,0,0.08);
            display: none; z-index: 1000;
            border-top-left-radius: 25px; border-top-right-radius: 25px;
        }
        .footer-content {
            max-width: 600px; margin: 0 auto; padding: 0 25px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .total-amount { font-size: 1.5rem; font-weight: 900; color: var(--text-main); }

        button {
            background: var(--primary); color: white; border: none;
            border-radius: 16px; padding: 14px 28px; font-size: 1rem;
            font-weight: 700; cursor: pointer;
        }

        @media (max-width: 450px) {
            .card { flex-direction: column; align-items: flex-start; }
            .controles { width: 100%; flex-direction: row; justify-content: space-between; margin-top: 10px; border-top: 1px solid #f0f0f0; padding-top: 10px; }
        }
    </style>
</head>
<body>

<header>
    <h1>Mis Clases UTN</h1>
</header>

<div id="loaderClases" class="loader">
    <div class="spinner"></div>
    <p style="font-weight: 600; color: var(--primary);">Cargando tu agenda...</p>
</div>

<div id="loaderPago" class="loader hidden">
    <div class="spinner"></div>
    <div style="font-weight: 800; color: var(--text-main); font-size: 1.2rem;">Conectando con el servidor</div>
    <div class="progress-container">
        <div class="progress-bar"></div>
    </div>
    <p class="warning-text">El servidor se est√° iniciando. Por favor, <b>no cierres ni refresques</b> esta p√°gina. Puede demorar hasta 1 minuto.</p>
</div>

<div class="container">
    <div class="productos" id="productos"></div>
</div>

<div class="footer-bar" id="totalContainer">
    <div class="footer-content">
        <div class="total-text">
            <div style="font-size: 0.8rem; color: var(--text-light); font-weight: 600;">TOTAL</div>
            <div class="total-amount">$<span id="total">0</span></div>
        </div>
        <button onclick="pagarSeleccion()">Pagar Clases</button>
    </div>
</div>

<script>
const correoAlumno = (typeof Alumno !== "undefined" && Alumno.correoElectronico)
    ? Alumno.correoElectronico
    : "valedasilvacatela.vdc@gmail.com";

const GAS_URL = "https://script.google.com/macros/s/AKfycbwvSTFpClvlYupAvfgpR7YTvd90x7AN0t4EJZ5x7xarJ-ga1wRtWxNTDDy-Wm4judEX/exec";
const BACKEND_URL = "https://mercadopago-di7q.onrender.com/crear-preferencia";

let clases = [];

async function cargarClases() {
    try {
        document.getElementById("loaderClases").classList.remove("hidden");
        const res = await fetch(`${GAS_URL}?funcion=devolverDeuda&correo=${encodeURIComponent(correoAlumno)}`);
        const data = await res.json();

        clases = data.map((c, index) => ({
            id: index,
            fecha: c.fecha,
            modalidad: c.modalidad,
            horas: c.horas,
            precioBase: parseFloat(c.precio) || 0,
            recargo: parseFloat(c.recargo) || 0,
            precioFinal: (parseFloat(c.precio) || 0) + (parseFloat(c.recargo) || 0)
        }));

        mostrarClases();
    } catch(e) {
        alert("Error al obtener las clases.");
    } finally {
        document.getElementById("loaderClases").classList.add("hidden");
    }
}

function mostrarClases() {
    const contenedor = document.getElementById("productos");
    contenedor.innerHTML = "";

    if (clases.length === 0) {
        contenedor.innerHTML = "<p style='text-align:center; color:var(--text-light); padding: 40px;'>No hay deudas pendientes.</p>";
        return;
    }

    clases.forEach(c => {
        const card = document.createElement("div");
        card.className = "card";
        const htmlRecargo = c.recargo > 0 ? `<div class="recargo-tag">Recargo: +$${c.recargo.toLocaleString('es-AR')}</div>` : "";
        const htmlBase = c.recargo > 0 ? `<div class="sub-price">$${c.precioBase.toLocaleString('es-AR')}</div>` : "";

        card.innerHTML = `
            <div class="info">
                <strong>${c.modalidad}</strong>
                <span class="details">üìÖ ${c.fecha}</span>
                <span class="details">‚è±Ô∏è ${c.horas} horas</span>
                ${htmlRecargo}
            </div>
            <div class="controles">
                <div style="text-align:right">
                    ${htmlBase}
                    <div class="price-display">$${c.precioFinal.toLocaleString('es-AR')}</div>
                </div>
                <label class="pago-checkbox">
                    <input type="checkbox" value="${c.id}" onchange="actualizarTotal()">
                    Pagar
                </label>
            </div>
        `;
        contenedor.appendChild(card);
    });
}

function actualizarTotal() {
    let total = 0;
    let haySeleccion = false;
    clases.forEach(c => {
        const cb = document.querySelector(`input[type="checkbox"][value="${c.id}"]`);
        if (cb && cb.checked) { total += c.precioFinal; haySeleccion = true; }
    });
    document.getElementById("totalContainer").style.display = haySeleccion ? "block" : "none";
    document.getElementById("total").textContent = total.toLocaleString('es-AR');
}

async function pagarSeleccion() {
    const items = [];
    clases.forEach(c => {
        const cb = document.querySelector(`input[type="checkbox"][value="${c.id}"]`);
        if (cb && cb.checked) {
            items.push({ title: `${c.modalidad} (${c.fecha})`, price: c.precioFinal });
        }
    });

    try {
        // Mostramos el loader con advertencia
        document.getElementById("loaderPago").classList.remove("hidden");

        const res = await fetch(BACKEND_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ items })
        });
        
        const data = await res.json();
        if (data.init_point) window.location.href = data.init_point;
        else throw new Error("No init_point");

    } catch(e) {
        alert("El servidor tard√≥ demasiado en responder o hubo un error. Por favor, intenta de nuevo.");
        document.getElementById("loaderPago").classList.add("hidden");
    }
}

cargarClases();
</script>
</body>
</html>
